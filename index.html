<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>my-private-space</title>
  <meta name="keywords" content="pomodoro timer, productivity app, cryptocurrency tracker, weather dashboard, glassmorphism UI, customizable dashboard, progressive web app, dark mode, light mode, real-time data, oneko animation, personal dashboard">
  <meta name="description" content="My Private Space is a customizable productivity dashboard with a Pomodoro timer, real-time cryptocurrency prices, weather updates, and a glassmorphism UI. Install as a PWA for offline access.">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet">
  <link rel="manifest" href="./manifest.json">
  <style>
:root {
  --glass-bg: rgba(10, 22, 38, 0.2);
  --primary-color: #2A3F5F;
  --accent-color: #4A6F8A;
  --text-color: #E2E2E3;
  --panel-radius: 28px;
  --notif-color: #3C5A7D;
  --transition-speed: 0.35s;
  --bg-color: #0A1626;
  --success-color: #4CAF50;
  --error-color: #D32F2F;
  --neutral-color: #95A5B5;
  --button-bg: var(--accent-color);
  --gradient-start: var(--primary-color);
  --gradient-end: var(--accent-color);
}
.light {
  --glass-bg: rgba(226, 226, 227, 0.2);
  --text-color: #0A1626;
  --bg-color: #E2E2E3;
  --primary-color: #A8B5C2;
  --accent-color: #7E94A8;
  --notif-color: #95A5B5;
  --success-color: #4CAF50;
  --error-color: #D32F2F;
  --neutral-color: #3C5A7D;
  --button-bg: var(--accent-color);
  --gradient-start: var(--primary-color);
  --gradient-end: var(--accent-color);
}
* { box-sizing: border-box; font-family: Roboto, sans-serif; }
html, body { height: 100%; margin: 0; }
body {
  color: var(--text-color);
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  background: url('assets/chihiro036.webp') center/cover no-repeat;
  background-color: var(--bg-color);
  transition: background 0.4s ease;
  position: relative;
}
body.dark::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(
    to bottom,
    rgba(0, 0, 0, 0.4),
    rgba(0, 0, 0, 0.4) 50%,
    rgba(0, 0, 0, 0.6)
  ),
  radial-gradient(
    circle at center,
    rgba(0, 0, 0, 0.2) 0%,
    rgba(0, 0, 0, 0.5) 70%,
    rgba(0, 0, 0, 0.7) 100%
  );
  backdrop-filter: blur(2px);
  z-index: -1;
  pointer-events: none;
}
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(24px);
  border-radius: var(--panel-radius);
  padding: 16px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.28);
  color: var(--text-color);
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.container {
  width: 100%;
  max-width: 1400px;
  display: flex;
  gap: 18px;
  padding: 20px;
  align-items: flex-start;
}
.panel-left, .panel-right { display: flex; flex-direction: column; gap: 10px; min-width: 200px; }
.panel-left div, .panel-right div { display: flex; align-items: center; gap: 10px; font-weight: 600; }
.icon { font-size: 1.4rem; color: var(--text-color); }
.center { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 18px; }
#time { font-size: 160px; font-weight: 700; line-height: 1; text-shadow: 0 6px 18px rgba(0,0,0,0.35); }
.date { font-size: 24px; opacity: 0.9; }
#dynamicIsland {
  position: relative;
  width: 120px;
  height: 120px;
  border-radius: 60px;
  background: var(--glass-bg);
  backdrop-filter: blur(24px);
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 8px 26px rgba(0,0,0,0.25);
  transition: transform .3s ease;
}
#dynamicIsland.pulse { animation: pulseIsland 1.5s infinite alternate; }
@keyframes pulseIsland { 0% { transform: scale(.985); } 50% { transform: scale(1.03); } 100% { transform: scale(.985); } }
#dynamicIsland canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 60px; }
#dynamicIslandTime { z-index: 2; font-weight: 700; }
#pomControlsIsland { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; }
#pomControlsIsland input[type="text"] {
  width: 72px;
  padding: 6px;
  border-radius: 10px;
  border: none;
  background: var(--glass-bg);
  color: var(--text-color);
  text-align: center;
  backdrop-filter: blur(8px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}
#pomControlsIsland input[type="text"]::placeholder {
  color: var(--text-color);
  opacity: 0.8;
}
#pomControlsIsland button { padding: 6px 10px; border-radius: 10px; border: none; cursor: pointer; font-weight: 600; }
#pomStartBtn { background: var(--primary-color); color: var(--text-color); }
#pomPauseBtn { background: var(--accent-color); color: var(--text-color); display: none; }
#pomResetBtn { background: var(--button-bg); color: var(--text-color); display: none; }
#notification {
  position: fixed;
  right: 28px;
  bottom: 28px;
  background: var(--notif-color);
  color: var(--text-color);
  padding: 12px 18px;
  border-radius: 24px;
  opacity: 0;
  transform: translateY(20px);
  transition: all .35s;
  display: flex;
  gap: 10px;
  align-items: center;
  z-index: 120;
}
#notification.show { opacity: 1; transform: translateY(0); }
.topTicker {
  position: fixed;
  top: 20px;
  left: 20px;
  width: calc(25vw - 20px);
  white-space: nowrap;
  overflow: hidden;
  border-radius: 12px;
  background: var(--glass-bg);
  backdrop-filter: blur(8px);
  padding: 8px 12px;
  z-index: 110;
}
.topTicker .tickerContent { display: flex; width: max-content; animation: topTickerScroll 15s linear infinite; }
.topTicker .tickerContent span { padding-right: 48px; }
@keyframes topTickerScroll { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
#prefGear {
  position: fixed;
  top: 18px;
  right: 18px;
  z-index: 200;
  width: 40px;
  height: 40px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--glass-bg);
  backdrop-filter: blur(10px);
  box-shadow: 0 8px 24px rgba(0,0,0,0.35);
  cursor: pointer;
  transition: transform 0.35s, box-shadow 0.35s;
}
#prefGear:hover { transform: rotate(6deg) scale(1.03); box-shadow: 0 12px 36px rgba(0,0,0,0.45); }
#prefGear:focus { outline: 2px solid var(--accent-color); }
.gear { font-size: 18px; transition: transform 0.6s cubic-bezier(.2,.9,.2,1); }
#prefGear.spin .gear { transform: rotate(360deg); }
#prefsOverlay.show #prefGear { display: none; }
#prefsOverlay:not(.show) #prefGear { display: flex; }
#themeToggle {
  position: fixed;
  top: 18px;
  right: 66px;
  z-index: 200;
  width: 40px;
  height: 40px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--glass-bg);
  backdrop-filter: blur(10px);
  box-shadow: 0 8px 24px rgba(0,0,0,0.35);
  cursor: pointer;
  transition: transform 0.35s, box-shadow 0.35s;
}
#themeToggle:hover { transform: scale(1.03); box-shadow: 0 12px 36px rgba(0,0,0,0.45); }
#themeToggle:focus { outline: 2px solid var(--accent-color); }
#themeToggle .theme-icon { font-size: 18px; }
#prefsOverlay {
  position: fixed;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  background: rgba(0,0,0,0.6);
  backdrop-filter: blur(0px);
  z-index: 300;
  opacity: 0;
  transition: opacity 0.6s cubic-bezier(0.4, 0, 0.2, 1), backdrop-filter 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  will-change: opacity, backdrop-filter;
}
#prefsOverlay.show {
  display: flex;
  opacity: 1;
  backdrop-filter: blur(10px);
}
#prefsOverlay.closing {
  opacity: 0;
  backdrop-filter: blur(0px);
}
#prefsModal {
  width: min(920px, 94vw);
  background: var(--glass-bg);
  backdrop-filter: blur(14px);
  border-radius: 16px;
  padding: 18px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.6);
  color: var(--text-color);
  display: grid;
  grid-template-columns: 1fr 320px;
  gap: 12px;
  transform: translateY(50px) scale(0.98);
  opacity: 0;
  transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  will-change: transform, opacity;
}
#prefsOverlay.show #prefsModal {
  transform: translateY(0) scale(1);
  opacity: 1;
}
#prefsOverlay.closing #prefsModal {
  transform: translateY(50px) scale(0.98);
  opacity: 0;
}
.prefsLeft, .prefsRight { display: flex; flex-direction: column; gap: 10px; }
.prefsCard { background: var(--glass-bg); padding: 12px; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.35); }
.field { display: flex; flex-direction: column; gap: 8px; margin-bottom: 10px; }
.label { font-size: .9rem; opacity: .95; }
.input, .select { background: var(--glass-bg); border: 1px solid rgba(0,0,0,0.1); padding: 8px; border-radius: 10px; color: var(--text-color); outline: none; }
.input:focus, .select:focus, .smallButton:focus { outline: 2px solid var(--accent-color); }
.smallButton { padding: 6px 12px; border-radius: 8px; border: none; background: var(--glass-bg); color: var(--text-color); cursor: pointer; font-weight: 500; }
.smallButton.active { background: var(--primary-color); color: var(--text-color); }
.smallButton:hover { background: var(--accent-color); }
.closeBtn {
  position: absolute;
  top: 12px;
  right: 12px;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--accent-color), var(--primary-color));
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255,255,255,0.2);
  color: var(--text-color);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 6px 16px rgba(0,0,0,0.4);
  transition: transform 0.2s, box-shadow 0.2s;
  z-index: 310;
  pointer-events: auto;
}
.closeBtn:hover { transform: scale(1.05); box-shadow: 0 8px 20px rgba(0,0,0,0.5); }
.closeBtn:focus { outline: 2px solid var(--accent-color); }
.closeBtn .material-icons-outlined { font-size: 26px; line-height: 1; }
.social-links { display: flex; justify-content: center; gap: 12px; margin-top: 10px; }
.social-links a { color: var(--accent-color); text-decoration: none; font-weight: 500; }
.social-links a:hover { opacity: 0.8; text-decoration: underline; }
.social-links a:focus { outline: 2px solid var(--accent-color); }
#floatingInstall {
  position: fixed;
  right: 28px;
  bottom: 100px;
  z-index: 220;
  display: none;
  align-items: center;
  gap: 10px;
  padding: 10px 14px;
  border-radius: 14px;
  min-width: 200px;
  background: var(--glass-bg);
  backdrop-filter: blur(10px);
  box-shadow: 0 14px 40px rgba(0,0,0,0.45);
}
#floatingInstall .fiTitle { font-weight: 700; font-size: 0.95rem; }
#floatingInstall .fiBtn { margin-left: auto; padding: 6px 10px; border-radius: 10px; background: var(--primary-color); color: var(--text-color); cursor: pointer; }

#pomSessionCount {
  padding: 6px 10px;
  border-radius: 10px;
  background: var(--glass-bg);
  color: var(--text-color);
  text-align: center;
  backdrop-filter: blur(8px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}
.media-field-container { display: flex; flex-direction: row; gap: 12px; flex-wrap: wrap; }
.wallpaper-field, .sound-field { display: flex; flex-direction: column; gap: 8px; flex: 1; min-width: 200px; }
.input-row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
@media (max-width: 900px) {
  #time { font-size: 120px; }
  .date { font-size: 20px; }
  #dynamicIsland { width: 100px; height: 100px; }
  #prefsModal {
    grid-template-columns: 1fr;
    max-height: calc(100vh - 40px);
    overflow-y: auto;
    padding-bottom: 20px;
  }
  #themeToggle { right: 60px; }
  .media-field-container { flex-direction: column; }
  .closeBtn {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 310;
    width: 42px;
    height: 42px;
  }
  .closeBtn .material-icons-outlined { font-size: 22px; }
  #prefsModal::-webkit-scrollbar {
    width: 8px;
  }
  #prefsModal::-webkit-scrollbar-track {
    background: transparent;
  }
  #prefsModal::-webkit-scrollbar-thumb {
    background: var(--accent-color);
    border-radius: 4px;
  }
  #prefGear {
    top: 14px;
    right: 14px;
    width: 36px;
    height: 36px;
  }
}
@media (max-width: 600px) {
  .container { flex-direction: column; align-items: center; gap: 12px; padding: 12px; }
  #time { font-size: 72px; }
  #dynamicIsland { width: 80px; height: 80px; }
  #themeToggle { right: 54px; top: 14px; width: 32px; height: 32px; }
  #prefGear {
    top: 12px;
    right: 12px;
    width: 32px;
    height: 32px;
  }
  #themeToggle .theme-icon { font-size: 16px; }
  .gear { font-size: 16px; }
  .input-row { flex-direction: column; gap: 12px; }
  .closeBtn {
    position: fixed;
    top: 16px;
    right: 16px;
    z-index: 310;
    width: 38px;
    height: 38px;
  }
  .closeBtn .material-icons-outlined { font-size: 20px; }
  #prefsModal {
    max-height: calc(100vh - 32px);
    overflow-y: auto;
    padding-bottom: 16px;
  }
  #prefsModal::-webkit-scrollbar {
    width: 6px;
  }
}
input::placeholder { opacity: 0.8; color: var(--text-color); }
  </style>
</head>
<body class="light">
  <div class="topTicker glass">
    <div class="tickerContent" id="tickerContent">
      <span id="tickerText">Welcome back, Ruben. Stay curious ðŸ’«</span>
      <span id="tickerTextDup">Welcome back, Ruben. Stay curious ðŸ’«</span>
    </div>
  </div>
  <div class="container">
    <div class="glass panel-left" id="infoPanel">
      <div><span class="material-icons-outlined icon">currency_bitcoin</span><span id="btc">BTC: ...</span></div>
      <div><span class="material-icons-outlined icon">token</span><span id="eth">ETH: ...</span></div>
      <div><span class="material-icons-outlined icon">currency_exchange</span><span id="pi">PI: ...</span></div>
      <div><span class="material-icons-outlined icon">paid</span><span id="usdt">USDT: ...</span></div>
    </div>
    <div class="center">
      <div id="time">00:00</div>
      <div id="date" class="date">-- -- ----</div>
      <div id="dynamicIsland">
        <canvas id="pomCanvas" aria-label="Pomodoro timer progress"></canvas>
        <div id="dynamicIslandTime">25:00</div>
      </div>
      <div id="pomControlsIsland">
        <input type="text" id="pomCustomTime" placeholder="Min" inputmode="numeric" pattern="\d*" aria-label="Pomodoro duration in minutes">
        <button id="pomStartBtn" tabindex="0">Start</button>
        <button id="pomPauseBtn" tabindex="0">Pause</button>
        <button id="pomResetBtn" tabindex="0">Reset</button>
      </div>
    </div>
    <div class="glass panel-right" id="weatherPanel">
      <div><span class="material-icons-outlined icon">cloud</span><span id="temp">--Â°C</span></div>
      <div><span class="material-icons-outlined icon">water_drop</span><span id="humidity">Humidity: --%</span></div>
      <div><span class="material-icons-outlined icon">waves</span><span id="dew">Dew: --Â°C</span></div>
      <div><span class="material-icons-outlined icon">air</span><span id="wind">Wind: -- km/h</span></div>
      <div><span class="material-icons-outlined icon">speed</span><span id="pressure">Pressure: -- hPa</span></div>
    </div>
  </div>

  <div id="notification" role="status" aria-live="assertive">
    <span id="notificationText">Time Up!</span>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="notifPauseBtn" class="smallButton" tabindex="0">Pause</button>
      <button id="notifStopBtn" class="smallButton" tabindex="0">Stop</button>
      <span class="material-symbols-outlined">alarm</span>
    </div>
  </div>
  <div id="floatingInstall" role="dialog" aria-hidden="true" class="glass" style="display:none">
    <div style="display:flex;align-items:center;gap:10px;width:100%">
      <div style="display:flex;flex-direction:column">
        <div class="fiTitle">Add to Home Screen</div>
        <div style="font-size:0.85rem;opacity:0.9">Install this app for quick access</div>
      </div>
      <button id="floatingInstallBtn" class="fiBtn" tabindex="0">Add</button>
    </div>
  </div>
  <div id="themeToggle" title="Toggle theme (light/dark)" tabindex="0">
    <span class="material-icons-outlined theme-icon">light_mode</span>
  </div>
  <div id="prefGear" title="Preferences (open)" tabindex="0">
    <span class="material-icons-outlined gear">settings</span>
  </div>
  <div id="prefsOverlay" aria-hidden="true">
    <div id="prefsModal" role="dialog" aria-modal="true" aria-label="Preferences">
      <button id="closePrefs" class="closeBtn" title="Close preferences" aria-label="Close preferences panel" tabindex="0">
        <span class="material-icons-outlined">close</span>
      </button>
      <div class="prefsLeft">
        <div class="field">
          <div class="label">Top ticker text</div>
          <input id="tickerInput" class="input" placeholder="Welcome back, Ruben. Stay curious ðŸ’«" tabindex="0">
        </div>
        <div class="field">
          <div class="label">Ticker speed (seconds loop)</div>
          <input id="tickerSpeed" type="number" min="6" max="60" class="input" tabindex="0">
        </div>
        <div class="media-field-container">
          <div class="wallpaper-field" style="flex: 1; min-width: 100px;">
            <div class="label">Wallpaper</div>
            <div class="input-row">
              <input id="wallUpload" type="file" accept="image/*" class="input" aria-label="Upload wallpaper" style="flex: 1; min-width: 100px;" tabindex="0">
            </div>
          </div>
          <div class="sound-field" style="flex: 1; min-width: 100px;">
            <div class="label">Notification Sound</div>
            <div class="input-row">
              <input id="soundUpload" type="file" accept="audio/*" class="input" aria-label="Upload sound" style="flex: 1; min-width: 100px;" tabindex="0">
            </div>
          </div>
        </div>
        <div class="media-field-container">
          <div class="field" style="flex: 1; min-width: 100px;">
            <div class="label">Pomodoro (minutes)</div>
            <input id="pomDefaultInput" type="number" class="input" min="1" max="180" style="flex: 1; min-width: 100px;" tabindex="0">
          </div>
          <div class="field" style="flex: 1; min-width: 100px;">
            <div class="label">Theme color (primary)</div>
            <input id="themeColor" type="color" class="input" style="flex: 1; min-width: 100px;" tabindex="0">
          </div>
        </div>
        <div class="field">
          <div class="label">Custom Themes</div>
          <div class="input-row">
            <input id="themePrimary" type="color" class="input" aria-label="Primary color" style="flex: 1; min-width: 80px;" tabindex="0">
            <input id="themeAccent" type="color" class="input" aria-label="Accent color" style="flex: 1; min-width: 80px;" tabindex="0">
            <input id="themeNotif" type="color" class="input" aria-label="Notification color" style="flex: 1; min-width: 80px;" tabindex="0">
            <button id="saveThemePreset" class="smallButton" tabindex="0">Save Theme</button>
          </div>
          <select id="themePresetSelect" class="select" aria-label="Select theme preset" tabindex="0">
            <option value="">Select Theme Preset</option>
          </select>
        </div>
        <div class="field">
          <div class="label">Temperature & Location</div>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
            <select id="tempUnit" class="select" tabindex="0">
              <option value="C">Celsius (Â°C)</option>
              <option value="F">Fahrenheit (Â°F)</option>
            </select>
            <div style="display:flex;gap:6px;">
              <button type="button" id="locDefault" class="smallButton active" tabindex="0">Manual</button>
              <button type="button" id="locAuto" class="smallButton" tabindex="0">Auto Detect</button>
            </div>
            <input id="cityInput" class="input" placeholder="Enter city (e.g., Lalitpur)" style="display:none; flex: 1; min-width: 100px;" tabindex="0">
          </div>
        </div>
        <div class="prefsCard">
          <div class="label">Oneko Cat Animation</div>
          <div style="margin-top:8px;display:flex;gap:6px;">
            <button id="onekoEnable" class="smallButton active" tabindex="0">Enable</button>
            <button id="onekoDisable" class="smallButton" tabindex="0">Disable</button>
          </div>
        </div>
      </div>
      <div class="prefsRight">
        <div class="prefsCard">
          <div class="label">Preview</div>
          <div style="margin-top:8px;display:flex;flex-direction:column;gap:10px">
            <div id="previewWallpaper" style="height:160px;border-radius:12px;background-size:cover;background-position:center;box-shadow:inset 0 0 30px rgba(0,0,0,0.08)"></div>
            <div class="row">
              <button id="savePrefs" class="smallButton" tabindex="0">Save</button>
              <button id="clearPrefs" class="smallButton" tabindex="0">Reset preferences</button>
            </div>
          </div>
        </div>
        <div class="prefsCard">
          <div class="label">Pomodoro Sessions</div>
          <div id="pomSessionCount">Sessions: 0</div>
        </div>
        <div class="prefsCard">
          <div class="label">Analytics</div>
          <div id="analyticsDisplay">Page loads: 0 | Timers started: 0</div>
        </div>
        <div class="prefsCard social-links">
          <a href="https://github.com/cosmic-swordfish" target="_blank" tabindex="0">GitHub</a>
          <a href="https://instagram.com/cosmic_swordfish/" target="_blank" tabindex="0">Instagram</a>
          <a href="https://www.rubenshahi.com.np//" target="_blank" tabindex="0">Site</a>
          <a href="mailto:reubenshahi2015@gmail.com" tabindex="0">Email</a>
        </div>
      </div>
    </div>
  </div>
  <script>
    const DEFAULTS = {
  themeColor: '#A8B5C2',
  ticker: 'Welcome back, Ruben. Stay curious ðŸ’«',
  pomDefault: 25,
  wallpaper: null,
  defaultWallpaper: 'assets/chihiro036.webp',
  city: 'Lalitpur',
  tempUnit: 'C',
  tickerSpeed: 15,
  locationMode: 'default',
  onekoEnabled: true,
  themeMode: 'light',
  customSound: null,
  themePresets: []
};
let prefs = JSON.parse(localStorage.getItem('mps_prefs') || 'null') || DEFAULTS;
const WEATHER_API_KEY = "d81009d2cbae458bbdb51509251210";
const notifAudio = document.createElement('audio');
notifAudio.id = 'notifSound';
notifAudio.preload = 'auto';
notifAudio.src = (function generateAlarmDataURL(duration = 10.0, freq = 880, sampleRate = 44100) {
  const len = Math.floor(duration * sampleRate);
  const samples = new Int16Array(len);
  for (let i = 0; i < len; i++) {
    const t = i / sampleRate;
    let env = t < 0.03 ? t / 0.03 : t < duration - 0.3 ? 0.9 : 0.9 * Math.max(0, 1 - (t - (duration - 0.3)) / 0.3);
    const trem = 0.03 * Math.sin(2 * Math.PI * 2 * t);
    const value = Math.sin(2 * Math.PI * freq * t) * (0.85 + trem) * env;
    samples[i] = Math.max(-1, Math.min(1, value)) * 0x7fff;
  }
  const buffer = new ArrayBuffer(44 + samples.length * 2);
  const view = new DataView(buffer);
  function writeString(view, offset, string) {
    for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i));
  }
  let offset = 0;
  writeString(view, offset, 'RIFF'); offset += 4;
  view.setUint32(offset, 36 + samples.length * 2, true); offset += 4;
  writeString(view, offset, 'WAVE'); offset += 4;
  writeString(view, offset, 'fmt '); offset += 4;
  view.setUint32(offset, 16, true); offset += 4;
  view.setUint16(offset, 1, true); offset += 2;
  view.setUint16(offset, 1, true); offset += 2;
  view.setUint32(offset, sampleRate, true); offset += 4;
  view.setUint32(offset, sampleRate * 2, true); offset += 4;
  view.setUint16(offset, 2, true); offset += 2;
  view.setUint16(offset, 16, true); offset += 2;
  writeString(view, offset, 'data'); offset += 4;
  view.setUint32(offset, samples.length * 2, true); offset += 4;
  for (let i = 0; i < samples.length; i++, offset += 2) view.setInt16(offset, samples[i], true);
  const binary = new Uint8Array(buffer);
  let binaryStr = '';
  const chunkSize = 0x8000;
  for (let i = 0; i < binary.length; i += chunkSize) {
    binaryStr += String.fromCharCode.apply(null, binary.subarray(i, i + chunkSize));
  }
  return 'data:audio/wav;base64,' + btoa(binaryStr);
})();
document.body.appendChild(notifAudio);
const prefGear = document.getElementById('prefGear');
const themeToggle = document.getElementById('themeToggle');
const themeIcon = document.querySelector('#themeToggle .theme-icon');
const prefsOverlay = document.getElementById('prefsOverlay');
const prefsModal = document.getElementById('prefsModal');
const wallUpload = document.getElementById('wallUpload');
const previewWallpaper = document.getElementById('previewWallpaper');
const tickerInput = document.getElementById('tickerInput');
const pomDefaultInput = document.getElementById('pomDefaultInput');
const tempUnit = document.getElementById('tempUnit');
const themeColor = document.getElementById('themeColor');
const themePrimary = document.getElementById('themePrimary');
const themeAccent = document.getElementById('themeAccent');
const themeNotif = document.getElementById('themeNotif');
const saveThemePreset = document.getElementById('saveThemePreset');
const themePresetSelect = document.getElementById('themePresetSelect');
const savePrefs = document.getElementById('savePrefs');
const closePrefs = document.getElementById('closePrefs');
const clearPrefs = document.getElementById('clearPrefs');
const tickerSpeed = document.getElementById('tickerSpeed');
const tickerTextEl = document.getElementById('tickerText');
const tickerTextDupEl = document.getElementById('tickerTextDup');
const locDefault = document.getElementById('locDefault');
const locAuto = document.getElementById('locAuto');
const cityInput = document.getElementById('cityInput');
const soundUpload = document.getElementById('soundUpload');
const floatingInstall = document.getElementById('floatingInstall');
const floatingInstallBtn = document.getElementById('floatingInstallBtn');
const analyticsDisplay = document.getElementById('analyticsDisplay');
const onekoEnable = document.getElementById('onekoEnable');
const onekoDisable = document.getElementById('onekoDisable');
let isAudioUnlocked = false;
let lastFocusedElement = null;

// Service Worker Registration
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/service-worker.js')
      .then(registration => {
        console.log('Service Worker registered with scope:', registration.scope);
        // Check for updates immediately
        registration.update();
      })
      .catch(error => {
        console.error('Service Worker registration failed:', error);
        showNotification('Failed to register Service Worker. Offline features may be unavailable.', 8000);
      });
    // Listen for controller changes
    navigator.serviceWorker.addEventListener('controllerchange', () => {
      window.location.reload();
    });
  });
  // Handle messages from service worker
  navigator.serviceWorker.addEventListener('message', (event) => {
    if (event.data.type === 'RELOAD') {
      window.location.reload();
    }
  });
}

function hexToHSL(hex) {
  let r = parseInt(hex.slice(1, 3), 16) / 255;
  let g = parseInt(hex.slice(3, 5), 16) / 255;
  let b = parseInt(hex.slice(5, 7), 16) / 255;
  let max = Math.max(r, g, b), min = Math.min(r, g, b);
  let h, s, l = (max + min) / 2;
  if (max === min) {
    h = s = 0;
  } else {
    let d = max - min;
    s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
    switch (max) {
      case r: h = (g - b) / d + (g < b ? 6 : 0); break;
      case g: h = (b - r) / d + 2; break;
      case b: h = (r - g) / d + 4; break;
    }
    h /= 6;
  }
  return { h: h * 360, s: s * 100, l: l * 100 };
}

function hslToHex(h, s, l) {
  l /= 100;
  const a = s * Math.min(l, 1 - l) / 100;
  const f = n => {
    const k = (n + h / 30) % 12;
    const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
    return Math.round(255 * color).toString(16).padStart(2, '0');
  };
  return `#${f(0)}${f(8)}${f(4)}`;
}

function deriveColors(primaryHex) {
  const { h, s, l } = hexToHSL(primaryHex);
  const isLight = document.body.classList.contains('light');
  const accentL = isLight ? Math.max(40, l - 10) : Math.min(90, l + 10);
  const notifL = isLight ? Math.min(85, l + 5) : Math.min(85, l + 5);
  return {
    accent: hslToHex(h, s, accentL),
    notif: hslToHex(h, s, notifL)
  };
}

function savePrefsToStorage() {
  const toStore = {
    themeColor: prefs.themeColor,
    ticker: prefs.ticker,
    pomDefault: prefs.pomDefault,
    wallpaper: prefs.wallpaper,
    city: prefs.city,
    tempUnit: prefs.tempUnit,
    tickerSpeed: prefs.tickerSpeed,
    locationMode: prefs.locationMode,
    onekoEnabled: prefs.onekoEnabled,
    themeMode: prefs.themeMode,
    customSound: prefs.customSound,
    themePresets: prefs.themePresets
  };
  localStorage.setItem('mps_prefs', JSON.stringify(toStore));
  prefs = Object.assign({}, DEFAULTS, toStore);
  const themeColorEvent = new CustomEvent('themeColorChanged', { detail: prefs.themeColor });
  window.dispatchEvent(themeColorEvent);
  // Force service worker update
  if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
    navigator.serviceWorker.controller.postMessage({ type: 'FORCE_UPDATE' });
  }
}

function preloadImage(url) {
  const img = new Image();
  img.src = url;
}

function applyWallpaper(w) {
  const final = w || DEFAULTS.defaultWallpaper;
  document.body.style.background = `url('${final}') center/cover no-repeat`;
  previewWallpaper.style.backgroundImage = `url('${final}')`;
}

let onekoScriptTag = null;
function loadOneko() {
  if (window.onekoLoaded) return;
  onekoScriptTag = document.createElement('script');
  onekoScriptTag.src = "https://cdn.jsdelivr.net/gh/adryd325/oneko.js/oneko.js";
  onekoScriptTag.dataset.cat = "https://cdn.jsdelivr.net/gh/adryd325/oneko.js/oneko.gif";
  onekoScriptTag.onload = () => { window.onekoLoaded = true; };
  document.body.appendChild(onekoScriptTag);
  onekoEnable.classList.add('active');
  onekoDisable.classList.remove('active');
}

function unloadOneko() {
  if (onekoScriptTag) {
    try { document.body.removeChild(onekoScriptTag); } catch (e) {}
    onekoScriptTag = null;
  }
  const catEls = document.querySelectorAll('img[src*="oneko.gif"], .oneko, #oneko, img.oneko');
  catEls.forEach(el => el.remove());
  window.onekoLoaded = false;
  onekoEnable.classList.remove('active');
  onekoDisable.classList.add('active');
}

function applyThemeMode(mode) {
  document.body.classList.remove('light', 'dark');
  document.body.classList.add(mode);
  themeIcon.textContent = mode === 'light' ? 'light_mode' : 'dark_mode';
}

function updateTickerAnimation() {
  const tickerContent = document.querySelector('.topTicker .tickerContent');
  const tickerText = tickerInput.value || DEFAULTS.ticker;
  tickerTextEl.textContent = tickerText;
  tickerTextDupEl.textContent = tickerText;
  const tempEl = document.createElement('span');
  tempEl.style.visibility = 'hidden';
  tempEl.style.position = 'absolute';
  tempEl.style.whiteSpace = 'nowrap';
  tempEl.style.font = getComputedStyle(tickerTextEl).font;
  tempEl.textContent = tickerText;
  document.body.appendChild(tempEl);
  const textWidth = tempEl.offsetWidth;
  document.body.removeChild(tempEl);
  const tickerWidth = document.querySelector('.topTicker').offsetWidth;
  const speedFactor = 100;
  const minDuration = 6;
  const maxDuration = 60;
  const duration = Math.max(minDuration, Math.min(maxDuration, (textWidth + tickerWidth) / speedFactor));
  tickerContent.style.animation = `topTickerScroll ${duration}s linear infinite`;
}

function applyThemePreset(preset) {
  if (!preset) return;
  document.documentElement.style.setProperty('--primary-color', preset.primary);
  document.documentElement.style.setProperty('--accent-color', preset.accent);
  document.documentElement.style.setProperty('--notif-color', preset.notif);
  prefs.themeColor = preset.primary;
  themeColor.value = preset.primary;
  const themeColorEvent = new CustomEvent('themeColorChanged', { detail: preset.primary });
  window.dispatchEvent(themeColorEvent);
  // Force service worker update
  if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
    navigator.serviceWorker.controller.postMessage({ type: 'FORCE_UPDATE' });
  }
}

function updateThemePresets() {
  themePresetSelect.innerHTML = '<option value="">Select Theme Preset</option>';
  prefs.themePresets.forEach((preset, index) => {
    const option = document.createElement('option');
    option.value = index;
    option.textContent = `Theme ${index + 1}`;
    themePresetSelect.appendChild(option);
  });
}

function applyPreferences() {
  prefs = Object.assign({}, DEFAULTS, prefs);
  preloadImage(DEFAULTS.defaultWallpaper);
  if (prefs.wallpaper) preloadImage(prefs.wallpaper);
  const isLight = document.body.classList.contains('light');
  const baseColor = isLight ? '#E2E2E3' : '#0A1626';
  const { h, s } = hexToHSL(baseColor);
  const primaryL = isLight ? 60 : 30;
  const derivedPrimary = hslToHex(h, isLight ? 20 : 40, primaryL);
  const { accent, notif } = deriveColors(prefs.themeColor || derivedPrimary);
  document.documentElement.style.setProperty('--primary-color', prefs.themeColor || derivedPrimary);
  document.documentElement.style.setProperty('--accent-color', accent);
  document.documentElement.style.setProperty('--notif-color', notif);
  tickerTextEl.textContent = prefs.ticker || DEFAULTS.ticker;
  tickerTextDupEl.textContent = prefs.ticker || DEFAULTS.ticker;
  updateTickerAnimation();
  applyWallpaper(prefs.wallpaper);
  if (!localStorage.getItem('pomTotal')) localStorage.setItem('pomTotal', (prefs.pomDefault || DEFAULTS.pomDefault) * 60);
  themeColor.value = prefs.themeColor || derivedPrimary;
  themePrimary.value = prefs.themeColor || derivedPrimary;
  themeAccent.value = accent;
  themeNotif.value = notif;
  tickerInput.value = prefs.ticker || DEFAULTS.ticker;
  pomDefaultInput.value = prefs.pomDefault || DEFAULTS.pomDefault;
  tempUnit.value = prefs.tempUnit || DEFAULTS.tempUnit;
  tickerSpeed.value = prefs.tickerSpeed || DEFAULTS.tickerSpeed;
  cityInput.value = prefs.city || DEFAULTS.city;
  cityInput.style.display = prefs.locationMode === 'default' ? 'block' : 'none';
  function setLocationMode(mode) {
    prefs.locationMode = mode;
    locDefault.classList.toggle('active', mode === 'default');
    locAuto.classList.toggle('active', mode === 'auto');
    cityInput.style.display = mode === 'default' ? 'block' : 'none';
  }
  locDefault.addEventListener('click', () => setLocationMode('default'));
  locAuto.addEventListener('click', () => setLocationMode('auto'));
  setLocationMode(prefs.locationMode);
  if (prefs.customSound) notifAudio.src = prefs.customSound;
  applyThemeMode(prefs.themeMode);
  if (prefs.onekoEnabled) loadOneko(); else unloadOneko();
  updateThemePresets();
}
applyPreferences();

function trapFocus(e) {
  const focusableElements = prefsModal.querySelectorAll(
    'button:not([disabled]), [href], input:not([disabled]), select:not([disabled]), [tabindex]:not([tabindex="-1"])'
  );
  const firstFocusable = focusableElements[0];
  const lastFocusable = focusableElements[focusableElements.length - 1];
  if (e.key === 'Tab') {
    if (e.shiftKey) {
      if (document.activeElement === firstFocusable) {
        e.preventDefault();
        lastFocusable.focus();
      }
    } else {
      if (document.activeElement === lastFocusable) {
        e.preventDefault();
        firstFocusable.focus();
      }
    }
  } else if (e.key === 'Escape') {
    e.preventDefault();
    handleClosePrefs(e);
  }
}

prefGear.addEventListener('click', () => {
  lastFocusedElement = document.activeElement;
  prefsOverlay.classList.add('show');
  prefGear.classList.add('spin');
  prefsOverlay.setAttribute('aria-hidden', 'false');
  prefGear.style.display = 'none';
  applyWallpaper(prefs.wallpaper || DEFAULTS.defaultWallpaper);
  tickerInput.focus();
  prefsModal.addEventListener('keydown', trapFocus);
});

prefGear.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' || e.key === ' ') {
    e.preventDefault();
    prefGear.click();
  }
});

themeToggle.addEventListener('click', () => {
  prefs.themeMode = prefs.themeMode === 'light' ? 'dark' : 'light';
  applyThemeMode(prefs.themeMode);
  applyPreferences();
  savePrefsToStorage();
});

themeToggle.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' || e.key === ' ') {
    e.preventDefault();
    themeToggle.click();
  }
});

onekoEnable.addEventListener('click', () => {
  prefs.onekoEnabled = true;
  loadOneko();
  savePrefsToStorage();
});

onekoEnable.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' || e.key === ' ') {
    e.preventDefault();
    onekoEnable.click();
  }
});

onekoDisable.addEventListener('click', () => {
  prefs.onekoEnabled = false;
  unloadOneko();
  savePrefsToStorage();
});

onekoDisable.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' || e.key === ' ') {
    e.preventDefault();
    onekoDisable.click();
  }
});

function handleClosePrefs(event) {
  event.preventDefault();
  event.stopPropagation();
  prefsOverlay.classList.add('closing');
  setTimeout(() => {
    prefsOverlay.classList.remove('show', 'closing');
    prefGear.classList.remove('spin');
    prefsOverlay.setAttribute('aria-hidden', 'true');
    prefGear.style.display = 'flex';
    prefGear.style.opacity = '1';
    prefGear.style.pointerEvents = 'auto';
    prefsModal.removeEventListener('keydown', trapFocus);
    if (lastFocusedElement) lastFocusedElement.focus();
  }, 600); // Match the CSS transition duration (0.6s)
}

closePrefs.addEventListener('click', handleClosePrefs);
closePrefs.addEventListener('touchend', handleClosePrefs);
closePrefs.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' || e.key === ' ') {
    e.preventDefault();
    closePrefs.click();
  }
});

wallUpload.addEventListener('change', async (e) => {
  const f = e.target.files[0];
  if (!f) return;
  if (f.size > 5 * 1024 * 1024) {
    showNotification('Image file too large (max 5MB)', 8000);
    return;
  }
  const reader = new FileReader();
  reader.onload = () => {
    prefs.wallpaper = reader.result;
    preloadImage(prefs.wallpaper);
    applyWallpaper(prefs.wallpaper);
  };
  reader.readAsDataURL(f);
});

soundUpload.addEventListener('change', async (e) => {
  const f = e.target.files[0];
  if (!f) return;
  if (f.size > 2 * 1024 * 1024) {
    showNotification('Audio file too large (max 2MB)', 8000);
    return;
  }
  const reader = new FileReader();
  reader.onload = () => {
    prefs.customSound = reader.result;
    notifAudio.src = prefs.customSound;
  };
  reader.readAsDataURL(f);
});

saveThemePreset.addEventListener('click', () => {
  if (prefs.themePresets.length >= 3) {
    showNotification('Maximum 3 theme presets allowed', 8000);
    return;
  }
  const newPreset = {
    primary: themePrimary.value,
    accent: themeAccent.value,
    notif: themeNotif.value
  };
  prefs.themePresets.push(newPreset);
  updateThemePresets();
  savePrefsToStorage();
  showNotification('Theme preset saved', 5000);
});

saveThemePreset.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' || e.key === ' ') {
    e.preventDefault();
    saveThemePreset.click();
  }
});

themePresetSelect.addEventListener('change', () => {
  const index = parseInt(themePresetSelect.value);
  if (!isNaN(index)) {
    applyThemePreset(prefs.themePresets[index]);
    savePrefsToStorage();
  }
});

themePresetSelect.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' || e.key === ' ') {
    e.preventDefault();
    themePresetSelect.dispatchEvent(new Event('change'));
  }
});

savePrefs.addEventListener('click', () => {
  prefs.ticker = tickerInput.value || DEFAULTS.ticker;
  prefs.pomDefault = parseInt(pomDefaultInput.value) || DEFAULTS.pomDefault;
  prefs.city = cityInput.value || DEFAULTS.city;
  prefs.tempUnit = tempUnit.value || DEFAULTS.tempUnit;
  prefs.themeColor = themeColor.value || DEFAULTS.themeColor;
  prefs.tickerSpeed = parseInt(tickerSpeed.value) || DEFAULTS.tickerSpeed;
  savePrefsToStorage();
  applyPreferences();
  fetchWeather();
  updateTickerAnimation();
  handleClosePrefs(new Event('click'));
});

savePrefs.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' || e.key === ' ') {
    e.preventDefault();
    savePrefs.click();
  }
});

clearPrefs.addEventListener('click', () => {
  if (!confirm('Reset preferences to defaults?')) return;
  localStorage.removeItem('mps_prefs');
  localStorage.removeItem('pomTotal');
  localStorage.removeItem('pomTime');
  localStorage.removeItem('pomPaused');
  localStorage.removeItem('pomStarted');
  localStorage.removeItem('previousPrices');
  localStorage.removeItem('pomSessionCount');
  localStorage.removeItem('analytics');
  localStorage.removeItem('pomLastUpdate');
  localStorage.removeItem('installPromptCount');
  prefs = Object.assign({}, DEFAULTS);
  if (!prefs.onekoEnabled) unloadOneko(); else loadOneko();
  savePrefsToStorage();
  applyPreferences();
  previewWallpaper.style.backgroundImage = `url('${DEFAULTS.defaultWallpaper}')`;
  floatingInstall.style.display = 'none';
  wallUpload.value = '';
  soundUpload.value = '';
  cityInput.value = DEFAULTS.city;
  showNotification('Preferences reset to defaults. Wallpaper restored to default.', 8000);
});

clearPrefs.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' || e.key === ' ') {
    e.preventDefault();
    clearPrefs.click();
  }
});

let installPromptCount = JSON.parse(localStorage.getItem('installPromptCount') || '{"visits":0, "interactions":0}');
function updateInstallPromptCount(type) {
  if (type === 'visit') installPromptCount.visits++;
  else if (type === 'interaction') installPromptCount.interactions++;
  localStorage.setItem('installPromptCount', JSON.stringify(installPromptCount));
}

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  window.deferredPrompt = e;
  if (installPromptCount.visits >= 3 || installPromptCount.interactions >= 5) {
    floatingInstall.style.display = 'flex';
    floatingInstall.setAttribute('aria-hidden', 'false');
    showNotification('Install My Private Space to your device for a standalone experience!', 10000);
  }
});

floatingInstallBtn.addEventListener('click', () => {
  updateInstallPromptCount('interaction');
  if (window.deferredPrompt) {
    window.deferredPrompt.prompt();
    window.deferredPrompt.userChoice.then((choiceResult) => {
      if (choiceResult.outcome === 'accepted') {
        showNotification('My Private Space is being installed!', 5000);
      }
      window.deferredPrompt = null;
      floatingInstall.style.display = 'none';
      floatingInstall.setAttribute('aria-hidden', 'true');
    });
  } else {
    floatingInstall.style.display = 'none';
    floatingInstall.setAttribute('aria-hidden', 'true');
  }
});

floatingInstallBtn.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' || e.key === ' ') {
    e.preventDefault();
    floatingInstallBtn.click();
  }
});

tickerInput.addEventListener('input', () => {
  updateTickerAnimation();
});

function updateTime() {
  const now = new Date();
  document.getElementById('time').textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
  document.getElementById('date').textContent = now.toLocaleDateString([], { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
}
setInterval(updateTime, 1000);
updateTime();

const previousPrices = JSON.parse(localStorage.getItem("previousPrices") || '{}');
async function fetchCrypto() {
  try {
    const res = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,pi-network,tether&vs_currencies=usd&include_24hr_change=true");
    if (!res.ok) throw new Error(`Crypto API failed: ${res.status}`);
    const data = await res.json();
    localStorage.setItem('lastCryptoData', JSON.stringify(data));
    function updateElement(id, coinData, symbol = '$') {
      const el = document.getElementById(id);
      const price = coinData.usd;
      const change = coinData.usd_24h_change;
      let arrow = change > 0.1
        ? `<span style="color:var(--success-color)">â–²</span>`
        : change < -0.1
        ? `<span style="color:var(--error-color)">â–¼</span>`
        : `<span style="color:var(--neutral-color)">â–¬</span>`;
      el.innerHTML = `${id.toUpperCase()}: ${symbol}${price.toLocaleString()} ${arrow}`;
      previousPrices[id] = price;
    }
    updateElement('btc', data.bitcoin);
    updateElement('eth', data.ethereum);
    if (data['pi-network'] && data['pi-network'].usd != null) updateElement('pi', data['pi-network']);
    else document.getElementById('pi').textContent = 'PI: N/A';
    updateElement('usdt', data.tether);
    localStorage.setItem('previousPrices', JSON.stringify(previousPrices));
  } catch (err) {
    showNotification(`Failed to fetch crypto prices: ${err.message}. Using cached data.`, 8000);
    const cachedData = localStorage.getItem('lastCryptoData');
    if (cachedData) {
      const data = JSON.parse(cachedData);
      function updateElement(id, coinData, symbol = '$') {
        const el = document.getElementById(id);
        const price = coinData.usd;
        const change = coinData.usd_24h_change;
        let arrow = change > 0.1
          ? `<span style="color:var(--success-color)">â–²</span>`
          : change < -0.1
          ? `<span style="color:var(--error-color)">â–¼</span>`
          : `<span style="color:var(--neutral-color)">â–¬</span>`;
        el.innerHTML = `${id.toUpperCase()}: ${symbol}${price.toLocaleString()} ${arrow} (cached)`;
      }
      updateElement('btc', data.bitcoin);
      updateElement('eth', data.ethereum);
      if (data['pi-network'] && data['pi-network'].usd != null) updateElement('pi', data['pi-network']);
      else document.getElementById('pi').textContent = 'PI: N/A';
      updateElement('usdt', data.tether);
    } else {
      ['btc', 'eth', 'pi', 'usdt'].forEach(id => document.getElementById(id).textContent = id.toUpperCase() + ': Error');
    }
  }
}
fetchCrypto();
setInterval(fetchCrypto, 120000);

function cToF(c) { return (c * 9 / 5) + 32; }

async function fetchWeather() {
  try {
    const CITY = (prefs && prefs.city) ? prefs.city : DEFAULTS.city;
    let query;
    if (prefs.locationMode === 'auto' && navigator.geolocation) {
      const coords = await new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(
          (pos) => resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude }),
          (e) => reject(e),
          { timeout: 10000, maximumAge: 60000, enableHighAccuracy: false }
        );
      }).catch((e) => {
        showNotification(`Geolocation failed: ${e.message}. Using default city: ${CITY}. Update in preferences if needed.`, 12000);
        return null;
      });
      if (coords) query = `${coords.lat},${coords.lon}`;
    }
    if (!query) {
      if (!CITY) throw new Error('No city specified');
      query = encodeURIComponent(CITY);
    }
    const res = await fetch(`https://api.weatherapi.com/v1/current.json?key=${WEATHER_API_KEY}&q=${query}`);
    if (!res.ok) throw new Error(`Weather API failed: ${res.status}`);
    const data = await res.json();
    localStorage.setItem('lastWeatherData', JSON.stringify(data));
    updateWeatherUI(data);
  } catch (e) {
    showNotification(`Failed to fetch weather: ${e.message}. Using cached data or check city settings.`, 10000);
    const cachedData = localStorage.getItem('lastWeatherData');
    if (cachedData) {
      updateWeatherUI(JSON.parse(cachedData));
    } else {
      document.getElementById('temp').textContent = 'Weather unavailable';
      document.getElementById('humidity').textContent = 'Humidity: --%';
      document.getElementById('dew').textContent = 'Dew: --';
      document.getElementById('wind').textContent = 'Wind: --';
      document.getElementById('pressure').textContent = 'Pressure: --';
    }
  }
}

function updateWeatherUI(data) {
  if (!data || !data.current) throw new Error('Invalid weather response');
  let tempC = typeof data.current.temp_c === 'number' ? data.current.temp_c : NaN;
  let displayTemp = prefs.tempUnit === 'F' ? cToF(tempC) : tempC;
  document.getElementById('temp').textContent = (isNaN(displayTemp) ? '--' : displayTemp.toFixed(1)) + (prefs.tempUnit === 'F' ? 'Â°F' : 'Â°C');
  document.getElementById('humidity').textContent = 'Humidity: ' + (data.current.humidity ?? '--') + '%';
  const dewC = data.current.dewpoint_c ?? null;
  const dew = (prefs.tempUnit === 'F' && dewC !== null) ? cToF(dewC) : dewC;
  document.getElementById('dew').textContent = 'Dew: ' + (dew !== null ? dew.toFixed(1) : '--') + (prefs.tempUnit === 'F' ? 'Â°F' : 'Â°C');
  document.getElementById('wind').textContent = 'Wind: ' + (data.current.wind_kph ?? '--') + ' km/h';
  document.getElementById('pressure').textContent = 'Pressure: ' + (data.current.pressure_mb ?? '--') + ' hPa';
}
fetchWeather();
setInterval(fetchWeather, 1800000);

const canvas = document.getElementById('pomCanvas');
const ctx = canvas.getContext('2d');
const pomDisplay = document.getElementById('dynamicIslandTime');
const dynamicIsland = document.getElementById('dynamicIsland');
let pomTotal = localStorage.getItem('pomTotal') ? parseInt(localStorage.getItem('pomTotal')) : (prefs.pomDefault || 25) * 60;
let pomTime = localStorage.getItem('pomTime') ? parseInt(localStorage.getItem('pomTime')) : pomTotal;
let isPaused = localStorage.getItem('pomPaused') === 'true';
let started = localStorage.getItem('pomStarted') === 'true';
let pomInterval = null;
let animationFrameId = null;
let sessionCount = parseInt(localStorage.getItem('pomSessionCount') || '0');
let lastTimerUpdate = localStorage.getItem('pomLastUpdate') ? parseInt(localStorage.getItem('pomLastUpdate')) : null;
let canvasWidth, canvasHeight, cx, cy, r;

function resizeCanvas() {
  canvasWidth = canvas.offsetWidth;
  canvasHeight = canvas.offsetHeight;
  canvas.width = canvasWidth;
  canvas.height = canvasHeight;
  cx = canvasWidth / 2;
  cy = canvasHeight / 2;
  r = Math.min(canvasWidth, canvasHeight) / 2 - 10;
}

let resizeTimeout;
window.addEventListener('resize', () => {
  clearTimeout(resizeTimeout);
  resizeTimeout = setTimeout(resizeCanvas, 100);
});
resizeCanvas();

function updatePomDisplay() {
  const m = Math.floor(pomTime / 60);
  const s = pomTime % 60;
  pomDisplay.textContent = `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
}

function updateSessionCount() {
  document.getElementById('pomSessionCount').textContent = `Sessions: ${sessionCount}`;
}

function savePomState() {
  localStorage.setItem('pomTotal', pomTotal);
  localStorage.setItem('pomTime', pomTime);
  localStorage.setItem('pomPaused', isPaused);
  localStorage.setItem('pomStarted', started);
  localStorage.setItem('pomSessionCount', sessionCount);
  localStorage.setItem('pomLastUpdate', Date.now());
}

function drawPom(timestamp) {
  ctx.clearRect(0, 0, canvasWidth, canvasHeight);
  const isLight = document.body.classList.contains('light');
  const bgArcColor = isLight ? 'rgba(168, 181, 194, 0.1)' : 'rgba(42, 63, 95, 0.1)';
  const glowColor = isLight ? 'rgba(126, 148, 168, 0.4)' : 'rgba(74, 111, 138, 0.4)';
  if (!started && !isPaused) {
    const waveAmp = 6;
    const waveFreq = 6;
    const speed = timestamp / 300;
    const steps = 500;
    ctx.beginPath();
    for (let i = 0; i <= steps; i++) {
      const angle = -Math.PI / 2 + (i / steps) * 2 * Math.PI;
      const wave = Math.sin(angle * waveFreq + speed) * waveAmp;
      const x = cx + (r + wave) * Math.cos(angle);
      const y = cy + (r + wave) * Math.sin(angle);
      if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
    }
    ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim();
    ctx.lineWidth = 10;
    ctx.lineCap = 'round';
    ctx.stroke();
  } else {
    const progress = 1 - pomTime / pomTotal;
    ctx.beginPath();
    ctx.arc(cx, cy, r, -Math.PI / 2 + 2 * Math.PI * progress, 1.5 * Math.PI);
    ctx.strokeStyle = bgArcColor;
    ctx.lineWidth = 12;
    ctx.stroke();
    if (!started && isPaused) {
      ctx.beginPath();
      ctx.arc(cx, cy, r, -Math.PI / 2, -Math.PI / 2 + 2 * Math.PI * progress);
      const grad = ctx.createConicGradient(-Math.PI / 2, cx, cy);
      grad.addColorStop(0, getComputedStyle(document.documentElement).getPropertyValue('--gradient-start').trim());
      grad.addColorStop(0.4, getComputedStyle(document.documentElement).getPropertyValue('--gradient-end').trim());
      grad.addColorStop(0.8, getComputedStyle(document.documentElement).getPropertyValue('--gradient-start').trim());
      grad.addColorStop(1, getComputedStyle(document.documentElement).getPropertyValue('--gradient-start').trim());
      ctx.strokeStyle = grad;
      ctx.lineWidth = 10;
      ctx.stroke();
    } else {
      const waveAmp = isPaused ? 2 : 6;
      const waveFreq = 6;
      const speed = timestamp / (isPaused ? 1200 : 300);
      const steps = 50;
      const grad = ctx.createConicGradient(-Math.PI / 2, cx, cy);
      grad.addColorStop(0, getComputedStyle(document.documentElement).getPropertyValue('--gradient-start').trim());
      grad.addColorStop(0.4, getComputedStyle(document.documentElement).getPropertyValue('--gradient-end').trim());
      grad.addColorStop(0.8, getComputedStyle(document.documentElement).getPropertyValue('--gradient-start').trim());
      grad.addColorStop(1, getComputedStyle(document.documentElement).getPropertyValue('--gradient-start').trim());
      ctx.strokeStyle = grad;
      ctx.beginPath();
      for (let i = 0; i <= steps * progress; i++) {
        const angle = -Math.PI / 2 + (i / steps) * 2 * Math.PI;
        const wave = Math.sin(angle * waveFreq + speed) * waveAmp;
        const x = cx + (r + wave) * Math.cos(angle);
        const y = cy + (r + wave) * Math.sin(angle);
        if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
      }
      const glow = isPaused ? Math.sin(timestamp / 3000 * Math.PI) * 6 + 8 : 0;
      ctx.shadowBlur = glow;
      ctx.shadowColor = glowColor;
      ctx.lineWidth = 10;
      ctx.lineCap = 'round';
      ctx.stroke();
      ctx.shadowBlur = 0;
    }
  }
  animationFrameId = requestAnimationFrame(drawPom);
}

function startPomAnimation() {
  if (!animationFrameId && document.visibilityState === 'visible') {
    animationFrameId = requestAnimationFrame(drawPom);
  }
}

function stopPomAnimation() {
  if (animationFrameId) {
    cancelAnimationFrame(animationFrameId);
    animationFrameId = null;
  }
}

document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'hidden') {
    stopPomAnimation();
  } else if (document.visibilityState === 'visible') {
    startPomAnimation();
  }
});

function unlockAudio() {
  if (isAudioUnlocked) return;
  const context = new (window.AudioContext || window.webkitAudioContext)();
  context.resume().then(() => {
    isAudioUnlocked = true;
    showNotification('Audio unlocked for notifications', 5000);
  }).catch((e) => {
    showNotification('Failed to unlock audio. Sound may not play.', 8000);
  });
}

function playNotificationSound() {
  if (!isAudioUnlocked) {
    unlockAudio();
    setTimeout(playNotificationSound, 100);
    return;
  }
  if (prefs.customSound) {
    notifAudio.src = prefs.customSound;
    notifAudio.play().catch(() => {
      showNotification('Audio playback blocked. Using fallback sound.', 8000);
      fallbackWebAudio();
    });
  } else {
    notifAudio.play().catch(() => {
      showNotification('Audio playback blocked. Using fallback sound.', 8000);
      fallbackWebAudio();
    });
  }
}

function fallbackWebAudio() {
  if (!isAudioUnlocked) return;
  const context = new (window.AudioContext || window.webkitAudioContext)();
  const oscillator = context.createOscillator();
  const gainNode = context.createGain();
  oscillator.type = 'sine';
  oscillator.frequency.setValueAtTime(880, context.currentTime);
  gainNode.gain.setValueAtTime(0.5, context.currentTime);
  oscillator.connect(gainNode);
  gainNode.connect(context.destination);
  oscillator.start();
  setTimeout(() => {
    gainNode.gain.exponentialRampToValueAtTime(0.0001, context.currentTime + 0.5);
    oscillator.stop(context.currentTime + 0.5);
  }, 2000);
}

async function requestNotificationPermission() {
  if (Notification.permission === 'granted') return true;
  if (Notification.permission !== 'denied') {
    const permission = await Notification.requestPermission();
    return permission === 'granted';
  }
  return false;
}

async function sendPushNotification(message) {
  if (Notification.permission !== 'granted') return;
  if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
    navigator.serviceWorker.controller.postMessage({
      type: 'SHOW_NOTIFICATION',
      title: 'My Private Space',
      options: {
        body: message,
        icon: 'icons/icon-192.png',
        badge: 'icons/icon-192.png'
      }
    });
  }
}

function showNotification(text = 'Time Up!', duration = 10000) {
  const notif = document.getElementById('notification');
  const notifText = document.getElementById('notificationText');
  const minutes = Math.floor(pomTotal / 60);
  notifText.textContent = text;
  notifText.setAttribute('aria-label', `${text} for Pomodoro timer of ${minutes} minutes`);
  notif.classList.add('show');
  setTimeout(() => notif.classList.remove('show'), duration);
}

const pomStartBtn = document.getElementById('pomStartBtn');
const pomPauseBtn = document.getElementById('pomPauseBtn');
const pomResetBtn = document.getElementById('pomResetBtn');
const pomCustomTime = document.getElementById('pomCustomTime');
const notifPauseBtn = document.getElementById('notifPauseBtn');
const notifStopBtn = document.getElementById('notifStopBtn');
let analytics = JSON.parse(localStorage.getItem('analytics') || '{"pageLoads":0,"timersStarted":0}');

function updateAnalytics(type) {
  if (type === 'pageLoad') analytics.pageLoads++;
  else if (type === 'timerStart') analytics.timersStarted++;
  localStorage.setItem('analytics', JSON.stringify(analytics));
  analyticsDisplay.textContent = `Page loads: ${analytics.pageLoads} | Timers started: ${analytics.timersStarted}`;
}
updateAnalytics('pageLoad');

pomStartBtn.addEventListener('click', () => {
  updateInstallPromptCount('interaction');
  if (!started && !isPaused) {
    const customTime = parseInt(pomCustomTime.value);
    if (customTime && customTime >= 1 && customTime <= 180) {
      pomTotal = customTime * 60;
      pomTime = pomTotal;
    } else {
      pomTotal = (prefs.pomDefault || DEFAULTS.pomDefault) * 60;
      pomTime = pomTotal;
    }
    pomStartBtn.style.display = 'none';
    pomPauseBtn.style.display = 'inline-block';
    pomResetBtn.style.display = 'inline-block';
    started = true;
    isPaused = false;
    dynamicIsland.classList.add('pulse');
    updateAnalytics('timerStart');
    pomInterval = setInterval(() => {
      if (pomTime > 0) {
        pomTime--;
        updatePomDisplay();
        savePomState();
      } else {
        clearInterval(pomInterval);
        pomInterval = null;
        started = false;
        sessionCount++;
        updateSessionCount();
        savePomState();
        dynamicIsland.classList.remove('pulse');
        showNotification('Time Up!', 10000);
        playNotificationSound();
        sendPushNotification('Pomodoro timer finished!');
        pomStartBtn.style.display = 'inline-block';
        pomPauseBtn.style.display = 'none';
        pomResetBtn.style.display = 'none';
      }
    }, 1000);
    savePomState();
    startPomAnimation();
    requestNotificationPermission();
  }
});

pomStartBtn.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' || e.key === ' ') {
    e.preventDefault();
    pomStartBtn.click();
  }
});

pomPauseBtn.addEventListener('click', () => {
  updateInstallPromptCount('interaction');
  if (started && !isPaused) {
    isPaused = true;
    clearInterval(pomInterval);
    pomInterval = null;
    pomPauseBtn.textContent = 'Resume';
    savePomState();
  } else if (started && isPaused) {
    isPaused = false;
    pomPauseBtn.textContent = 'Pause';
    pomInterval = setInterval(() => {
      if (pomTime > 0) {
        pomTime--;
        updatePomDisplay();
        savePomState();
      } else {
        clearInterval(pomInterval);
        pomInterval = null;
        started = false;
        sessionCount++;
        updateSessionCount();
        savePomState();
        dynamicIsland.classList.remove('pulse');
        showNotification('Time Up!', 10000);
        playNotificationSound();
        sendPushNotification('Pomodoro timer finished!');
        pomStartBtn.style.display = 'inline-block';
        pomPauseBtn.style.display = 'none';
        pomResetBtn.style.display = 'none';
      }
    }, 1000);
    savePomState();
  }
});

pomPauseBtn.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' || e.key === ' ') {
    e.preventDefault();
    pomPauseBtn.click();
  }
});

pomResetBtn.addEventListener('click', () => {
  updateInstallPromptCount('interaction');
  clearInterval(pomInterval);
  pomInterval = null;
  pomTime = pomTotal;
  started = false;
  isPaused = false;
  pomStartBtn.style.display = 'inline-block';
  pomPauseBtn.style.display = 'none';
  pomResetBtn.style.display = 'none';
  pomPauseBtn.textContent = 'Pause';
  dynamicIsland.classList.remove('pulse');
  updatePomDisplay();
  savePomState();
});

pomResetBtn.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' || e.key === ' ') {
    e.preventDefault();
    pomResetBtn.click();
  }
});

notifPauseBtn.addEventListener('click', () => {
  updateInstallPromptCount('interaction');
  if (started && !isPaused) {
    pomPauseBtn.click();
    notifPauseBtn.textContent = 'Resume';
  } else if (started && isPaused) {
    pomPauseBtn.click();
    notifPauseBtn.textContent = 'Pause';
  }
});

notifPauseBtn.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' || e.key === ' ') {
    e.preventDefault();
    notifPauseBtn.click();
  }
});

notifStopBtn.addEventListener('click', () => {
  updateInstallPromptCount('interaction');
  pomResetBtn.click();
  showNotification('Timer stopped', 5000);
});

notifStopBtn.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' || e.key === ' ') {
    e.preventDefault();
    notifStopBtn.click();
  }
});

function checkMissedTime() {
  if (lastTimerUpdate && started && !isPaused) {
    const now = Date.now();
    const elapsed = Math.floor((now - lastTimerUpdate) / 1000);
    pomTime = Math.max(0, pomTime - elapsed);
    if (pomTime <= 0) {
      clearInterval(pomInterval);
      pomInterval = null;
      started = false;
      sessionCount++;
      updateSessionCount();
      savePomState();
      dynamicIsland.classList.remove('pulse');
      showNotification('Time Up!', 10000);
      playNotificationSound();
      sendPushNotification('Pomodoro timer finished!');
      pomStartBtn.style.display = 'inline-block';
      pomPauseBtn.style.display = 'none';
      pomResetBtn.style.display = 'none';
    }
    updatePomDisplay();
    savePomState();
  }
}
checkMissedTime();
updatePomDisplay();
updateSessionCount();
startPomAnimation();
</script>
</body>
</html>
