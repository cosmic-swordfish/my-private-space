<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>my-private-space</title>

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet">

<!-- If you add manifest.json to folder this link will activate PWA icons / install metadata -->
<link rel="manifest" href="./manifest.json">
<style>
:root {
 --glass-bg: rgba(255,255,255,0.08);
 --glass-blur: 24px;
 --primary-color: #5C7C75;
 --accent-color: #ff6b6b;
 --text-color: #fff;
 --panel-radius: 28px;
 --notif-color: #5C7C75;
 --transition-speed: 0.35s;
 --overlay-bg: rgba(0,0,0,0.45);
}

*{box-sizing:border-box;font-family:Roboto,system-ui,-apple-system,Segoe UI,Arial,sans-serif}
html,body{height:100%}
body{
 margin:0;
 color:var(--text-color);
 display:flex;
 align-items:center;
 justify-content:center;
 min-height:100vh;
 background: url('assets/chihiro036.jpeg') center/cover no-repeat;
 transition: background 0.4s ease;
}

/* glass base */
.glass{
 background:var(--glass-bg);
 backdrop-filter: blur(var(--glass-blur));
 border-radius:var(--panel-radius);
 padding:16px;
 box-shadow: 0 10px 30px rgba(0,0,0,0.28);
 color:var(--text-color);
 display:flex;
 flex-direction:column;
 gap:10px;
 transition: all var(--transition-speed) ease;
}

/* layout */
.container{
 width:100%;
 max-width:1400px;
 display:flex;
 gap:18px;
 padding:20px;
 align-items:flex-start;
}
.panel-left,.panel-right{display:flex;flex-direction:column;gap:10px;min-width:200px}
.panel-left div,.panel-right div{display:flex;align-items:center;gap:10px;font-weight:600}
.icon{font-size:1.4rem;color:var(--text-color)}

/* centre */
.center{flex:1;display:flex;flex-direction:column;align-items:center;gap:18px}
#time{font-size:160px;font-weight:700;line-height:1;text-shadow:0 6px 18px rgba(0,0,0,0.35)}
.date{font-size:24px;opacity:0.9}

/* Dynamic Island */
#dynamicIsland{position:relative;width:120px;height:120px;border-radius:60px;background:var(--glass-bg);backdrop-filter:blur(var(--glass-blur));display:flex;align-items:center;justify-content:center;box-shadow:0 8px 26px rgba(0,0,0,0.25);transition:transform .3s ease}
#dynamicIsland.pulse{animation:pulseIsland 1.5s infinite alternate}
@keyframes pulseIsland{0%{transform:scale(.985)}50%{transform:scale(1.03)}100%{transform:scale(.985)}}
#dynamicIsland canvas{position:absolute;top:0;left:0;width:100%;height:100%;border-radius:60px}
#dynamicIslandTime{z-index:2;font-weight:700}

/* pom controls */
#pomControlsIsland{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
#pomControlsIsland input[type=text] {
    width: 72px;
    padding: 6px;
    border-radius: 10px;
    border: none;
    background: rgba(255, 255, 255, 0.06);
    color: var(--text-color);
    text-align: center;

    /* Blur effect */
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px); /* Safari support */

    /* Drop shadow */
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); /* x-offset, y-offset, blur-radius, color */
}

/* pomedoro input placeholder */
#pomControlsIsland input[type="text"]::placeholder {
  color: #fff;
  opacity: 0.8;
}
#pomControlsIsland button{padding:6px 10px;border-radius:10px;border:none;cursor:pointer;font-weight:600}
#pomStartBtn{background:var(--primary-color);color:#fff}
#pomPauseBtn{background:var(--accent-color);color:#fff;display:none}
#pomResetBtn{background:#444;color:#fff;display:none}

/* notification */
#notification{position:fixed;right:28px;bottom:28px;background:var(--notif-color);color:#fff;padding:12px 18px;border-radius:24px;opacity:0;transform:translateY(20px);transition:all .35s;display:flex;gap:10px;align-items:center;z-index:120}
#notification.show{opacity:1;transform:translateY(0)}

/* ticker */
.topTicker{position:fixed;top:20px;left:20px;width:calc(25vw - 20px);white-space:nowrap;overflow:hidden;border-radius:12px;background:rgba(255,255,255,0.06);backdrop-filter:blur(8px);padding:8px 12px;z-index:110}
.topTicker .tickerContent{display:flex;width:max-content;animation:topTickerScroll 15s linear infinite}
.topTicker .tickerContent span{padding-right:48px}
@keyframes topTickerScroll{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}
/* Preferences gear */
#prefGear {
  position: fixed;
  top: 22px;
  right: 22px;
  z-index: 200;
  width: 52px;
  height: 52px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--glass-bg);
  backdrop-filter: blur(10px);
  box-shadow: 0 10px 36px rgba(0,0,0,0.35);
  cursor: pointer;
  transition: transform 0.35s, box-shadow 0.35s;
}
#prefGear:hover {
  transform: rotate(6deg) scale(1.03);
  box-shadow: 0 16px 46px rgba(0,0,0,0.45);
}
.gear {
  font-size: 22px;
  transition: transform 0.6s cubic-bezier(.2,.9,.2,1);
}
#prefGear.spin .gear {
  transform: rotate(360deg);
}

/* Overlay & modal */
#prefsOverlay {
  position: fixed;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  background: rgba(0,0,0,0.6);
  z-index: 300;
  opacity: 0;
  transition: opacity 0.35s ease;
}
#prefsOverlay.show {
  display: flex;
  opacity: 1;
}
#prefsModal {
  width: min(920px, 94vw);
  background: rgba(18,18,18,0.36);
  backdrop-filter: blur(14px);
  border-radius: 16px;
  padding: 14px 18px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.6);
  color: var(--text-color);
  display: grid;
  grid-template-columns: 1fr 320px;
  gap: 12px;
}
.prefsLeft, .prefsRight { display: flex; flex-direction: column; gap: 10px; }
.prefsCard { background: rgba(255,255,255,0.03); padding: 12px; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.35); }
.field { display: flex; flex-direction: column; gap: 8px; margin-bottom: 10px; }
.label { font-size: .9rem; opacity: .95; }
.input, .select { background: rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.04); padding: 8px; border-radius:10px; color:var(--text-color); outline:none; }

.smallButton.active {
  background: var(--primary-color);
  color: #fff;
}
.smallButton {
  padding:6px 12px;
  border-radius:8px;
  border:none;
  background: rgba(255,255,255,0.04);
  color: #fff;
  cursor: pointer;
  font-weight: 500;
  transition: background 0.3s, color 0.3s;
}
.smallButton:hover {
  background: rgba(255,255,255,0.08);
}

.radio-group { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
.radio-group label { font-size:.9rem; font-weight: normal; }

/* Close buttons */
.closeBtn {
  background: transparent;
  border: none;
  color: #fff;
  font-weight: 700;
  cursor: pointer;
  padding: 8px;
  border-radius: 10px;
  align-self: flex-end;
  opacity: 0.8;
  transition: opacity 0.25s;
}
.closeBtn:hover { opacity: 1; }

/* Social / Contact section */
.social-links { display: flex; justify-content: center; gap: 12px; margin-top: 10px; }
.social-links a { color: var(--accent-color); text-decoration:none; font-weight:500; transition: opacity 0.3s; }
.social-links a:hover { opacity:0.8; text-decoration: underline; }

/* Modal animation */
@keyframes prefsSlideUp {
  from { transform: translateY(40px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}
#prefsOverlay.show #prefsModal {
  animation: prefsSlideUp 0.35s ease-out;
}





/* floating install prompt (bottom-right) */
#floatingInstall{
 position:fixed;
 right:28px;
 bottom:100px; /* above notification */
 z-index:220;
 display:none;
 align-items:center;
 gap:10px;
 padding:10px 14px;
 border-radius:14px;
 min-width:200px;
 background:var(--glass-bg);
 backdrop-filter:blur(10px);
 box-shadow:0 14px 40px rgba(0,0,0,0.45);
}
#floatingInstall .fiTitle{font-weight:700;font-size:0.95rem}
#floatingInstall .fiBtn{margin-left:auto;padding:6px 10px;border-radius:10px;background:var(--primary-color);border:none;color:#fff;cursor:pointer}


/* Footer — centered & flexible */
.footer {
  position: fixed;
  left: 0;
  right: 0;
  bottom: 20px;
  text-align: center;
  font-size: clamp(0.85rem, 2vw, 1rem);
  opacity: 0.75;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  line-height: 1.4;
  z-index: 100; /* stays above backgrounds but below modals */


/* responsive */
@media(max-width:900px){
 #time{font-size:120px}
 .date{font-size:20px}
 #dynamicIsland{width:100px;height:100px}
 #prefsModal{grid-template-columns:1fr}
}
@media(max-width:600px){
 .container{flex-direction:column;align-items:center;gap:12px;padding:12px}
 #time{font-size:72px}
 #dynamicIsland{width:80px;height:80px}
}
.small{font-size:.9rem;opacity:.9}
.smallButton{padding:6px 10px;border-radius:8px;border:none;background:rgba(255,255,255,0.04);color:#fff;cursor:pointer}

/* ensure placeholder visible for numeric input */
input::placeholder {opacity:0.8;color:rgba(255,255,255,0.7)}
</style>
</head>
<body>

<!-- Top ticker -->
<div class="topTicker glass">
  <div class="tickerContent" id="tickerContent">
    <span id="tickerText">Welcome back, Ruben. Stay curious 💫</span>
    <span id="tickerTextDup">Welcome back, Ruben. Stay curious 💫</span>
  </div>
</div>

<div class="container">
  <!-- left panel: crypto -->
  <div class="glass panel-left" id="infoPanel">
    <div><span class="material-icons-outlined icon">currency_bitcoin</span><span id="btc">BTC: ...</span></div>
    <div><span class="material-icons-outlined icon">token</span><span id="eth">ETH: ...</span></div>
    <div><span class="material-icons-outlined icon">currency_exchange</span><span id="pi">PI: ...</span></div>
    <div><span class="material-icons-outlined icon">paid</span><span id="usdt">USDT: ...</span></div>
  </div>

  <!-- center: clock and pomodoro -->
  <div class="center">
    <div id="time">00:00</div>
    <div id="date" class="date">-- -- ----</div>

    <div id="dynamicIsland">
      <canvas id="pomCanvas"></canvas>
      <div id="dynamicIslandTime">25:00</div>
    </div>

    <div id="pomControlsIsland">
      <!-- changed type to text so placeholder is visible on all browsers; inputmode numeric helps mobile -->
      <input type="text" id="pomCustomTime" placeholder="Min" inputmode="numeric" pattern="\d*">
      <button id="pomStartBtn">Start</button>
      <button id="pomPauseBtn">Pause</button>
      <button id="pomResetBtn">Reset</button>
    </div>
  </div>

  <!-- right: weather -->
  <div class="glass panel-right" id="weatherPanel">
    <div><span class="material-icons-outlined icon">cloud</span><span id="temp">--°C</span></div>
    <div><span class="material-icons-outlined icon">water_drop</span><span id="humidity">Humidity: --%</span></div>
    <div><span class="material-icons-outlined icon">waves</span><span id="dew">Dew: --°C</span></div>
    <div><span class="material-icons-outlined icon">air</span><span id="wind">Wind: -- km/h</span></div>
    <div><span class="material-icons-outlined icon">speed</span><span id="pressure">Pressure: -- hPa</span></div>
  </div>
</div>

<div class="footer">🐾 Magic Mirror | Powered by oneko.js</div>

<!-- notification with controls -->
<div id="notification" role="status" aria-live="polite">
  <span id="notificationText">Time Up!</span>
  <div style="display:flex;gap:8px;align-items:center">
    <button id="notifPauseBtn" class="smallButton">Pause</button>
    <button id="notifStopBtn" class="smallButton">Stop</button>
    <span class="material-symbols-outlined">alarm</span>
  </div>
</div>

<!-- floating install prompt (bottom-right glass) -->
<div id="floatingInstall" role="dialog" aria-hidden="true" class="glass" style="display:none">
  <div style="display:flex;align-items:center;gap:10px;width:100%">
    <div style="display:flex;flex-direction:column">
      <div class="fiTitle">Add to Home Screen</div>
      <div style="font-size:0.85rem;opacity:0.9">Install this app for quick access</div>
    </div>
    <button id="floatingInstallBtn" class="fiBtn">Add</button>
  </div>
</div>

<!-- Preferences Gear -->
<div id="prefGear" title="Preferences (open)">
  <span class="material-icons-outlined gear">settings</span>
</div>

<!-- Preferences Overlay -->
<div id="prefsOverlay" aria-hidden="true">
  <div id="prefsModal" role="dialog" aria-modal="true" aria-label="Preferences">
    <div class="prefsLeft">

      <div class="field">
        <div class="label">Wallpaper</div>
        <input id="wallUpload" type="file" accept="image/*" class="input" aria-label="Upload wallpaper">
      </div>

      <div class="field">
        <div class="label">Top ticker text</div>
        <input id="tickerInput" class="input" placeholder="Welcome back, Ruben. Stay curious 💫">
      </div>

      <div class="field">
        <div class="label">Pomodoro default (minutes)</div>
        <input id="pomDefaultInput" type="number" class="input" min="1" max="180">
      </div>

    <div class="field">
  <div class="label">Temperature & Location</div>
  <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
    <!-- Temperature Unit -->
    <select id="tempUnit" class="select">
      <option value="C">Celsius (°C)</option>
      <option value="F">Fahrenheit (°F)</option>
    </select>

    <!-- Location Buttons -->
    <div style="display:flex;gap:6px;">
      <button type="button" id="locDefault" class="smallButton active">Lalitpur</button>
      <button type="button" id="locAuto" class="smallButton">Auto Detect</button>
    </div>
  </div>
</div>

      <div class="field">
        <div class="label">Theme color (primary)</div>
        <input id="themeColor" type="color" class="input" style="width:56px;height:44px;padding:6px">
      </div>

      <div class="field">
        <div class="label">Ticker speed (seconds loop)</div>
        <input id="tickerSpeed" type="number" min="6" max="60" class="input">
      </div>

      <div class="field">
        <div class="label">Oneko Lily</div>
        <div class="radio-group">
          <label><input type="radio" name="onekoMode" value="enable"> Enable</label>
          <label><input type="radio" name="onekoMode" value="disable"> Disable</label>
        </div>
      </div>

    </div>

    <div class="prefsRight">
      <div class="prefsCard">
        <div class="label">Preview</div>
        <div style="margin-top:8px;display:flex;flex-direction:column;gap:10px">
          <div id="previewWallpaper" style="height:160px;border-radius:12px;background-size:cover;background-position:center;box-shadow:inset 0 0 30px rgba(0,0,0,0.08)"></div>
          <div class="row">
            <button id="savePrefs" class="closeBtn">Save</button>
            <button id="closePrefs" class="closeBtn">Close</button>
          </div>
        </div>
      </div>

      <div class="prefsCard">
        <div class="label">Other Controls</div>
        <div style="margin-top:8px;display:flex;flex-direction:column;gap:8px">
          <button id="clearPrefs" class="closeBtn">Reset preferences</button>
          <button id="installPWA" class="closeBtn" style="display:none">Install PWA</button>
        </div>
      </div>

      <div class="prefsCard social-links">
        <a href="https://github.com/yourname" target="_blank">GitHub</a>
        <a href="https://twitter.com/yourname" target="_blank">Twitter</a>
        <a href="mailto:your@email.com">Email</a>
      </div>
    </div>
  </div>
</div>



<!-- oneko cat will be loaded dynamically based on preference -->

<script>
/* Single-file app.js — preferences, clock, APIs, pomodoro, canvas animation, PWA hooks */

/* small embedded alarm generator (now default 10s) */
function generateAlarmDataURL(duration = 10.0, freq = 880, sampleRate = 44100){
  const len = Math.floor(duration * sampleRate);
  const samples = new Int16Array(len);
  for(let i=0;i<len;i++){
    const t = i / sampleRate;
    // smooth envelope: short attack, sustain, slow release
    let env;
    if(t < 0.03) env = t / 0.03; // 30ms attack
    else if(t < duration - 0.3) env = 0.9; // sustain
    else env = 0.9 * Math.max(0, 1 - (t - (duration - 0.3)) / 0.3); // 300ms release
    // small slow amplitude modulation to avoid harshness
    const trem = 0.03 * Math.sin(2 * Math.PI * 2 * t);
    const value = Math.sin(2 * Math.PI * freq * t) * (0.85 + trem) * env;
    samples[i] = Math.max(-1, Math.min(1, value)) * 0x7fff;
  }
  const buffer = new ArrayBuffer(44 + samples.length * 2);
  const view = new DataView(buffer);
  function writeString(view, offset, string){
    for(let i=0;i<string.length;i++) view.setUint8(offset + i, string.charCodeAt(i));
  }
  let offset = 0;
  writeString(view, offset, 'RIFF'); offset += 4;
  view.setUint32(offset, 36 + samples.length * 2, true); offset += 4;
  writeString(view, offset, 'WAVE'); offset += 4;
  writeString(view, offset, 'fmt '); offset += 4;
  view.setUint32(offset, 16, true); offset += 4;
  view.setUint16(offset, 1, true); offset += 2;
  view.setUint16(offset, 1, true); offset += 2;
  view.setUint32(offset, sampleRate, true); offset += 4;
  view.setUint32(offset, sampleRate * 2, true); offset += 4;
  view.setUint16(offset, 2, true); offset += 2;
  view.setUint16(offset, 16, true); offset += 2;
  writeString(view, offset, 'data'); offset += 4;
  view.setUint32(offset, samples.length * 2, true); offset += 4;
  for(let i=0;i<samples.length;i++, offset+=2) view.setInt16(offset, samples[i], true);
  const binary = new Uint8Array(buffer);
  let binaryStr = '';
  const chunkSize = 0x8000;
  for (let i = 0; i < binary.length; i += chunkSize) {
    binaryStr += String.fromCharCode.apply(null, binary.subarray(i, i + chunkSize));
  }
  const base64 = btoa(binaryStr);
  return 'data:audio/wav;base64,' + base64;
}
const notifAudio = document.createElement('audio');
notifAudio.id = 'notifSound';
notifAudio.preload = 'auto';
notifAudio.src = generateAlarmDataURL(10.0, 880); // 10s smooth tone
document.body.appendChild(notifAudio);

/* --------------------------
   Defaults & preferences
   -------------------------- */
const WEATHER_API_KEY = "d81009d2cbae458bbdb51509251210"; // keep as-is
const DEFAULTS = {
  themeColor: getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim() || '#5C7C75',
  ticker: 'Welcome back, Ruben. Stay curious 💫',
  pomDefault: 25,
  wallpaper: null,
  defaultWallpaper: 'assets/chihiro036.jpeg',
  city: 'Lalitpur',
  tempUnit: 'C',
  tickerSpeed: 15,
  locationMode: 'default', // default or auto
  onekoEnabled: true
};

let prefs = JSON.parse(localStorage.getItem('mps_prefs') || 'null') || DEFAULTS;

/* --------------------------
   UI elements
   -------------------------- */
const prefGear = document.getElementById('prefGear');
const prefsOverlay = document.getElementById('prefsOverlay');
const wallUpload = document.getElementById('wallUpload');
const previewWallpaper = document.getElementById('previewWallpaper');
const tickerInput = document.getElementById('tickerInput');
const pomDefaultInput = document.getElementById('pomDefaultInput');
const cityInput = document.getElementById('cityInput');
const tempUnit = document.getElementById('tempUnit');
const themeColor = document.getElementById('themeColor');
const savePrefs = document.getElementById('savePrefs');
const closePrefs = document.getElementById('closePrefs');
const clearPrefs = document.getElementById('clearPrefs');
const installPWA = document.getElementById('installPWA');
const tickerSpeed = document.getElementById('tickerSpeed');
const tickerTextEl = document.getElementById('tickerText');
const tickerTextDupEl = document.getElementById('tickerTextDup');

const locDefault = document.getElementById('locDefault');
const locAuto = document.getElementById('locAuto');
const onekoRadios = document.querySelectorAll('input[name="onekoMode"]');

/* PWA floating install */
const floatingInstall = document.getElementById('floatingInstall');
const floatingInstallBtn = document.getElementById('floatingInstallBtn');

/* --------------------------
   Helper functions
   -------------------------- */
function savePrefsToStorage(){
  const toStore = {
    themeColor: prefs.themeColor,
    ticker: prefs.ticker,
    pomDefault: prefs.pomDefault,
    wallpaper: prefs.wallpaper,
    city: prefs.city,
    tempUnit: prefs.tempUnit,
    tickerSpeed: prefs.tickerSpeed,
    locationMode: prefs.locationMode,
    onekoEnabled: prefs.onekoEnabled
  };
  localStorage.setItem('mps_prefs', JSON.stringify(toStore));
  prefs = Object.assign({}, DEFAULTS, toStore);
}


/* Apply wallpaper */
function applyWallpaper(w){
  const final = w || DEFAULTS.defaultWallpaper;
  document.body.style.background = `url('${final}') center/cover no-repeat`;
  previewWallpaper.style.backgroundImage = `url('${final}')`;
}

/* Oneko loader/unloader */
let onekoScriptTag = null;
function loadOneko(){
  if(window.onekoLoaded) return;
  onekoScriptTag = document.createElement('script');
  onekoScriptTag.src = "https://cdn.jsdelivr.net/gh/adryd325/oneko.js/oneko.js";
  onekoScriptTag.dataset.cat = "https://cdn.jsdelivr.net/gh/adryd325/oneko.js/oneko.gif";
  onekoScriptTag.onload = () => { window.onekoLoaded = true; };
  document.body.appendChild(onekoScriptTag);
}
function unloadOneko(){
  if(onekoScriptTag){
    try { document.body.removeChild(onekoScriptTag); } catch(e){}
    onekoScriptTag = null;
  }
  const catEls = document.querySelectorAll('img[src*="oneko.gif"], .oneko, #oneko, img.oneko');
  catEls.forEach(el => el.remove());
  document.querySelectorAll('[style*="position:fixed"]').forEach(el=>{
    if(el && el.querySelector && el.querySelector('img') && el.querySelector('img').src && el.querySelector('img').src.includes('oneko')) el.remove();
  });
  window.onekoLoaded = false;
}

/* Apply stored preferences on load */
function applyPreferences(){
  prefs = Object.assign({}, DEFAULTS, prefs);

  document.documentElement.style.setProperty('--primary-color', prefs.themeColor || DEFAULTS.themeColor);
  tickerTextEl.textContent = prefs.ticker || DEFAULTS.ticker;
  tickerTextDupEl.textContent = prefs.ticker || DEFAULTS.ticker;
  const animSec = Math.max(6, prefs.tickerSpeed || DEFAULTS.tickerSpeed);
  const tickerContent = document.querySelector('.topTicker .tickerContent');
  if(tickerContent) tickerContent.style.animationDuration = animSec + 's';

  applyWallpaper(prefs.wallpaper);

  if(!localStorage.getItem('pomTotal')) {
    localStorage.setItem('pomTotal', (prefs.pomDefault||DEFAULTS.pomDefault) * 60);
  }

  // populate form fields
  themeColor.value = prefs.themeColor || DEFAULTS.themeColor;
  tickerInput.value = prefs.ticker || DEFAULTS.ticker;
  pomDefaultInput.value = prefs.pomDefault || DEFAULTS.pomDefault;
  tempUnit.value = prefs.tempUnit || DEFAULTS.tempUnit;
  tickerSpeed.value = prefs.tickerSpeed || DEFAULTS.tickerSpeed;

const locDefault = document.getElementById('locDefault');
const locAuto = document.getElementById('locAuto');

function setLocationMode(mode){
  prefs.locationMode = mode;
  if(mode === 'default'){
    locDefault.classList.add('active');
    locAuto.classList.remove('active');
  } else {
    locDefault.classList.remove('active');
    locAuto.classList.add('active');
  }
}

locDefault.addEventListener('click', ()=> setLocationMode('default'));
locAuto.addEventListener('click', ()=> setLocationMode('auto'));

// initialize based on prefs
setLocationMode(prefs.locationMode);
  onekoRadios.forEach(r => r.checked = (prefs.onekoEnabled === (r.value === "enable")));

  if(prefs.onekoEnabled) loadOneko(); else unloadOneko();
}
applyPreferences();

/* --------------------------
   Event listeners
   -------------------------- */

/* Open/close preference panel */
prefGear.addEventListener('click', ()=>{
  prefGear.classList.toggle('spin');
  prefsOverlay.classList.toggle('show');
  prefsOverlay.setAttribute('aria-hidden', prefsOverlay.classList.contains('show') ? 'false' : 'true');
});

closePrefs.addEventListener('click', ()=>{
  prefsOverlay.classList.remove('show');
  prefGear.classList.remove('spin');
});

/* Wallpaper upload */
wallUpload.addEventListener('change', async (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = ()=>{
    prefs.wallpaper = reader.result;
    previewWallpaper.style.backgroundImage = `url('${prefs.wallpaper}')`;
    applyWallpaper(prefs.wallpaper);
  };
  reader.readAsDataURL(f);
});

/* Save preferences */
savePrefs.addEventListener('click', ()=>{
  prefs.ticker = tickerInput.value || DEFAULTS.ticker;
  prefs.pomDefault = parseInt(pomDefaultInput.value) || DEFAULTS.pomDefault;
  prefs.city = prefs.locationMode === 'default' ? DEFAULTS.city : '';
  prefs.tempUnit = tempUnit.value || DEFAULTS.tempUnit;
  prefs.themeColor = themeColor.value || DEFAULTS.themeColor;
  prefs.tickerSpeed = parseInt(tickerSpeed.value) || DEFAULTS.tickerSpeed;

  // Oneko toggle
  const selectedOneko = document.querySelector('input[name="onekoMode"]:checked').value;
  prefs.onekoEnabled = (selectedOneko === "enable");

  savePrefsToStorage();
  applyPreferences();
  prefsOverlay.classList.remove('show');
  prefGear.classList.remove('spin');
});

/* Reset preferences */
clearPrefs.addEventListener('click', ()=>{
  if(!confirm('Reset preferences to defaults?')) return;
  localStorage.removeItem('mps_prefs');
  localStorage.removeItem('pomTotal');
  localStorage.removeItem('pomTime');
  localStorage.removeItem('pomPaused');
  localStorage.removeItem('pomStarted');
  localStorage.removeItem('previousPrices');

  prefs = Object.assign({}, DEFAULTS);
  if(!prefs.onekoEnabled) unloadOneko(); else loadOneko();

  savePrefsToStorage();
  applyPreferences();

  previewWallpaper.style.backgroundImage = `url('${DEFAULTS.defaultWallpaper}')`;
  floatingInstall.style.display = 'none';
  installPWA.style.display = 'none';

  alert('Preferences reset to defaults. Wallpaper restored to default.');
});

/* PWA install prompt handling */
window.addEventListener('beforeinstallprompt', (e)=>{
  e.preventDefault();
  window.deferredPrompt = e;
  // show both the prefs button and the floating prompt
  installPWA.style.display = 'inline-block';
  floatingInstall.style.display = 'flex';
  floatingInstall.setAttribute('aria-hidden','false');
});
installPWA.addEventListener('click', ()=>{
  if(window.deferredPrompt){
    window.deferredPrompt.prompt();
    window.deferredPrompt.userChoice.then(()=>{ window.deferredPrompt = null; installPWA.style.display = 'none'; floatingInstall.style.display = 'none'; });
  } else {
    alert('Install prompt not available. Serve over HTTPS and try again.');
  }
});
floatingInstallBtn.addEventListener('click', ()=>{
  if(window.deferredPrompt){
    window.deferredPrompt.prompt();
    window.deferredPrompt.userChoice.then(()=>{ window.deferredPrompt = null; installPWA.style.display = 'none'; floatingInstall.style.display = 'none'; });
  } else {
    floatingInstall.style.display = 'none';
  }
});

/* live ticker input preview */
tickerInput.addEventListener('input', ()=>{ const v = tickerInput.value || DEFAULTS.ticker; tickerTextEl.textContent = v; tickerTextDupEl.textContent = v; });

/* --------------------------
   Clock
   -------------------------- */
function updateTime(){
  const now = new Date();
  document.getElementById('time').textContent = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:false});
  document.getElementById('date').textContent = now.toLocaleDateString([], {weekday:'short', month:'short', day:'numeric', year:'numeric'});
}
setInterval(updateTime,1000); updateTime();

/* --------------------------
   Crypto (CoinGecko)
   -------------------------- */
const previousPrices = JSON.parse(localStorage.getItem("previousPrices") || '{}');

async function fetchCrypto(){
  try{
    const res = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,pi-network,tether&vs_currencies=usd&include_24hr_change=true");
    const data = await res.json();

    function updateElement(id, coinData, symbol='$'){
      const el = document.getElementById(id);
      const price = coinData.usd;
      const change = coinData.usd_24h_change;
      let arrow = '';
      if(change > 0.1) arrow = `<span style="color:#00ff88">▲</span>`;
      else if(change < -0.1) arrow = `<span style="color:#ff5555">▼</span>`;
      else arrow = `<span style="color:#aaa">▬</span>`;
      el.innerHTML = `${id.toUpperCase()}: ${symbol}${price.toLocaleString()} ${arrow}`;
      previousPrices[id] = price;
    }

    updateElement('btc', data.bitcoin);
    updateElement('eth', data.ethereum);
    if(data['pi-network'] && data['pi-network'].usd != null) updateElement('pi', data['pi-network']);
    else document.getElementById('pi').textContent = 'PI: N/A';
    updateElement('usdt', data.tether);

    localStorage.setItem('previousPrices', JSON.stringify(previousPrices));
  } catch(err){
    console.error('Crypto fetch error', err);
    ['btc','eth','pi','usdt'].forEach(id => document.getElementById(id).textContent = id.toUpperCase()+': Error');
  }
}
fetchCrypto();
setInterval(fetchCrypto, 120000);

/* --------------------------
   Weather (WeatherAPI) — supports manual city or auto geolocation
   -------------------------- */
function cToF(c){ return (c * 9/5) + 32; }

async function fetchWeather(){
  try{
    const CITY = (prefs && prefs.city) ? prefs.city : DEFAULTS.city;

    // Auto location
    if(prefs.locationMode === 'auto' && navigator.geolocation){
      const coords = await new Promise((resolve, reject) => {
        const ok = (pos) => resolve({lat: pos.coords.latitude, lon: pos.coords.longitude});
        const err = (e) => reject(e);
        navigator.geolocation.getCurrentPosition(ok, err, {timeout:7000});
      }).catch((e) => {
        console.warn('Geolocation failed, falling back to manual city', e);
        return null;
      });
      if(coords){
        const res = await fetch(`https://api.weatherapi.com/v1/current.json?key=${WEATHER_API_KEY}&q=${coords.lat},${coords.lon}`);
        if(!res.ok) throw new Error('Weather fetch failed');
        const data = await res.json();
        return updateWeatherUI(data);
      }
      // else fallthrough to manual city
    }

    // Manual city fallback
    const res = await fetch(`https://api.weatherapi.com/v1/current.json?key=${WEATHER_API_KEY}&q=${encodeURIComponent(CITY)}`);
    if(!res.ok) throw new Error('Weather fetch failed');
    const data = await res.json();
    updateWeatherUI(data);

  } catch(e){
    console.error('Weather error', e);
    document.getElementById('temp').textContent = 'Weather unavailable';
    document.getElementById('humidity').textContent = 'Humidity: --%';
    document.getElementById('dew').textContent = 'Dew: --';
    document.getElementById('wind').textContent = 'Wind: --';
    document.getElementById('pressure').textContent = 'Pressure: --';
  }
}

function updateWeatherUI(data){
  if(!data || !data.current) throw new Error('Invalid weather response');

  let tempC = typeof data.current.temp_c === 'number' ? data.current.temp_c : NaN;
  let displayTemp = tempC;
  if(prefs.tempUnit === 'F') displayTemp = cToF(tempC);

  document.getElementById('temp').textContent = (isNaN(displayTemp) ? '--' : displayTemp.toFixed(1)) + (prefs.tempUnit === 'F' ? '°F' : '°C');
  document.getElementById('humidity').textContent = 'Humidity: ' + (data.current.humidity ?? '--') + '%';

  const dewC = data.current.dewpoint_c ?? null;
  const dew = (prefs.tempUnit === 'F' && dewC !== null) ? cToF(dewC) : dewC;
  document.getElementById('dew').textContent = 'Dew: ' + (dew !== null ? dew.toFixed(1) : '--') + (prefs.tempUnit === 'F' ? '°F' : '°C');

  document.getElementById('wind').textContent = 'Wind: ' + (data.current.wind_kph ?? '--') + ' km/h';
  document.getElementById('pressure').textContent = 'Pressure: ' + (data.current.pressure_mb ?? '--') + ' hPa';
}

fetchWeather();
setInterval(fetchWeather, 1800000);

/* --------------------------
   Pomodoro w/ canvas animation
   -------------------------- */
const canvas = document.getElementById('pomCanvas');
const ctx = canvas.getContext('2d');
const pomDisplay = document.getElementById('dynamicIslandTime');
const dynamicIsland = document.getElementById('dynamicIsland');

let pomTotal = localStorage.getItem('pomTotal') ? parseInt(localStorage.getItem('pomTotal')) : (prefs.pomDefault || 25) * 60;
let pomTime = localStorage.getItem('pomTime') ? parseInt(localStorage.getItem('pomTime')) : pomTotal;
let isPaused = localStorage.getItem('pomPaused') === 'true';
let started = localStorage.getItem('pomStarted') === 'true';
let pomInterval = null;

function resizeCanvas(){ canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight; }
resizeCanvas(); window.addEventListener('resize', resizeCanvas);

function updatePomDisplay(){
  const m = Math.floor(pomTime / 60);
  const s = pomTime % 60;
  pomDisplay.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

function savePomState(){
  localStorage.setItem('pomTotal', pomTotal);
  localStorage.setItem('pomTime', pomTime);
  localStorage.setItem('pomPaused', isPaused);
  localStorage.setItem('pomStarted', started);
}

/* Draw expressive circular wavy progress */
function drawPom(){
  const w = canvas.width;
  const h = canvas.height;
  const cx = w/2;
  const cy = h/2;
  const r = Math.min(w,h)/2 - 10;
  ctx.clearRect(0,0,w,h);

  if(started){
    // background arc for remaining
    const progress = 1 - pomTime / pomTotal;
    ctx.beginPath();
    ctx.arc(cx, cy, r, -Math.PI/2 + 2*Math.PI*progress, 1.5*Math.PI);
    ctx.strokeStyle = 'rgba(255,255,255,0.06)';
    ctx.lineWidth = 12;
    ctx.stroke();
  }

  if(!started){
    // indeterminate wavy ring
    const waveAmp = 6;
    const waveFreq = 6;
    const speed = Date.now() / 300;
    const steps = 500;
    ctx.beginPath();
    for(let i=0;i<=steps;i++){
      const angle = -Math.PI/2 + (i/steps)*2*Math.PI;
      const wave = Math.sin(angle*waveFreq + speed) * waveAmp;
      const x = cx + (r + wave) * Math.cos(angle);
      const y = cy + (r + wave) * Math.sin(angle);
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.strokeStyle = '#5C7C75';
    ctx.lineWidth = 10;
    ctx.stroke();
  } else {
    const progress = 1 - pomTime / pomTotal;
    const waveAmp = isPaused ? 2 : 6;
    const waveFreq = 6;
    const speed = Date.now() / (isPaused?1200:300);
    const steps = 500;
    const grad = ctx.createConicGradient(-Math.PI/2, cx, cy);
    grad.addColorStop(0, '#5C7C75');
    grad.addColorStop(0.4, '#ff6b6b');
    grad.addColorStop(0.8, '#5C7C75');
    grad.addColorStop(1, '#5C7C75');
    ctx.strokeStyle = grad;
    ctx.beginPath();
    for(let i=0;i<=steps*progress;i++){
      const angle = -Math.PI/2 + (i/steps)*2*Math.PI;
      const wave = Math.sin(angle*waveFreq + speed) * waveAmp;
      const x = cx + (r + wave) * Math.cos(angle);
      const y = cy + (r + wave) * Math.sin(angle);
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    const glow = isPaused ? Math.sin(Date.now()/3000*Math.PI) * 6 + 8 : 0;
    ctx.shadowBlur = glow;
    ctx.shadowColor = 'rgba(255,255,255,0.45)';
    ctx.lineWidth = 10;
    ctx.lineCap = 'round';
    ctx.stroke();
    ctx.shadowBlur = 0;
  }

  requestAnimationFrame(drawPom);
}
drawPom();

/* pom controls */
function startPom(){
  // read numeric minutes from text input (allow empty)
  const raw = document.getElementById('pomCustomTime').value.trim();
  const val = raw ? parseInt(raw.replace(/\D/g,''),10) : null;
  if(val > 0){ pomTotal = val * 60; pomTime = pomTotal; }
  // store default pom if user provided pomDefault
  started = true;
  isPaused = false;
  savePomState();
  dynamicIsland.classList.add('pulse');
  document.getElementById('pomStartBtn').style.display = 'none';
  document.getElementById('pomPauseBtn').style.display = 'inline-block';
  document.getElementById('pomResetBtn').style.display = 'inline-block';
  if(pomInterval) return;
  pomInterval = setInterval(()=>{
    if(!isPaused && started){
      pomTime--;
      if(pomTime <= 0){
        clearInterval(pomInterval); pomInterval = null;
        showNotification();
        resetPom();
      }
      updatePomDisplay(); savePomState();
    }
  }, 1000);
}

function pausePom(){
  isPaused = !isPaused;
  document.getElementById('pomPauseBtn').textContent = isPaused ? 'Resume' : 'Pause';
  dynamicIsland.classList.toggle('pulse', !isPaused);
  savePomState();
}

function resetPom(){
  clearInterval(pomInterval); pomInterval = null;
  started = false; isPaused = false;
  pomTime = pomTotal;
  updatePomDisplay();
  dynamicIsland.classList.remove('pulse');
  document.getElementById('pomStartBtn').style.display = 'inline-block';
  document.getElementById('pomPauseBtn').style.display = 'none';
  document.getElementById('pomResetBtn').style.display = 'none';
  savePomState();
}

/* show notification + play audio for 10s; keep pause visible while playing */
let notifTimeout = null;
function showNotification(text = 'Time Up!'){
  const notif = document.getElementById('notification');
  document.getElementById('notificationText').textContent = text;
  notif.classList.add('show');

  // ensure pause button is visible and set to "Pause" by default
  const notifPauseBtn = document.getElementById('notifPauseBtn');
  notifPauseBtn.textContent = 'Pause';

  try {
    notifAudio.currentTime = 0;
    // try to play; if autoplay is blocked, this will be caught
    const p = notifAudio.play();
    if(p && p.catch){
      p.catch(e => console.warn('Audio play prevented', e));
    }
  } catch(e){ console.warn('Audio play prevented', e); }

  // keep visible for entire 10s — allow pause/resume for the audio
  if(notifTimeout) clearTimeout(notifTimeout);
  notifTimeout = setTimeout(()=> {
    notif.classList.remove('show');
    try { notifAudio.pause(); notifAudio.currentTime = 0; } catch(e){}
  }, 10000); // 10 seconds
}

/* notification controls — pause/resume audio during the full 10s */
document.getElementById('notifPauseBtn').addEventListener('click', ()=>{
  if(!notifAudio) return;
  if(!notifAudio.paused){ notifAudio.pause(); document.getElementById('notifPauseBtn').textContent = 'Resume'; }
  else { notifAudio.play().catch(()=>{}); document.getElementById('notifPauseBtn').textContent = 'Pause'; }
});
document.getElementById('notifStopBtn').addEventListener('click', ()=>{
  if(!notifAudio) return;
  notifAudio.pause(); notifAudio.currentTime = 0; document.getElementById('notification').classList.remove('show');
  if(notifTimeout) { clearTimeout(notifTimeout); notifTimeout = null; }
});

/* event bindings */
document.getElementById('pomStartBtn').addEventListener('click', startPom);
document.getElementById('pomPauseBtn').addEventListener('click', pausePom);
document.getElementById('pomResetBtn').addEventListener('click', resetPom);

updatePomDisplay();
if(started) startPom();

/* --------------------------
   PWA service worker registration (if service-worker.js exists)
   -------------------------- */
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('./service-worker.js').catch(()=>{ /* ignore if not present */ });
}

/* hide prompt if user dismisses manually / when installed */
window.addEventListener('appinstalled', ()=>{
  installPWA.style.display = 'none';
  floatingInstall.style.display = 'none';
  window.deferredPrompt = null;
});

/* Ensure floating install is dismissible by clicking outside (optional UX) */
floatingInstall.addEventListener('keydown', (e) => {
  if(e.key === 'Escape') floatingInstall.style.display = 'none';
});
</script>
</body>
</html>
